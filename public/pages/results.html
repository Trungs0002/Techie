<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>K·∫øt qu·∫£ thi - Techie</title>
  
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Custom CSS -->
  <link rel="stylesheet" href="/tracnghiemluyenthi/public/assets/css/main.css">
  <link rel="stylesheet" href="/tracnghiemluyenthi/public/assets/css/components.css">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <style>
    @keyframes confetti {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }

    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      z-index: 9999;
      animation: confetti 3s ease-out forwards;
    }
  </style>
</head>
<body class="bg-gray-50">
  <!-- Navigation -->
  <nav class="bg-white shadow-sm">
    <div class="container mx-auto px-4">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center space-x-2">
          <i class="fas fa-graduation-cap text-2xl text-blue-600"></i>
          <span class="text-xl font-bold text-gray-800">Techie</span>
        </div>

        <div class="flex items-center gap-3">
          <a href="/tracnghiemluyenthi/public/pages/dashboard.html" class="btn btn-secondary btn-sm">
            <i class="fas fa-home"></i>
            Dashboard
          </a>
          <a href="/tracnghiemluyenthi/public/pages/history.html" class="btn btn-outline btn-sm">
            <i class="fas fa-history"></i>
            L·ªãch s·ª≠
          </a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="container mx-auto px-4 py-6">
    <!-- Score Card -->
    <div class="max-w-4xl mx-auto">
      <!-- Result Header -->
      <div class="card bg-gradient-to-br from-blue-600 to-indigo-600 text-white mb-6 text-center animate-fade-in">
        <div class="mb-4">
          <div class="inline-flex items-center justify-center w-20 h-20 bg-white bg-opacity-20 rounded-full mb-4">
            <i class="fas fa-trophy text-4xl" id="resultIcon"></i>
          </div>
          <h1 class="text-3xl font-bold mb-2" id="resultTitle">Ho√†n th√†nh b√†i thi!</h1>
          <p class="text-blue-100" id="examTitle">ƒêang t·∫£i...</p>
        </div>

        <!-- Score Display -->
        <div class="bg-white bg-opacity-10 rounded-xl p-6 backdrop-blur-sm">
          <p class="text-sm opacity-90 mb-2">ƒêi·ªÉm s·ªë c·ªßa b·∫°n</p>
          <div class="text-6xl font-bold mb-2" id="scoreDisplay">0</div>
          <div class="flex items-center justify-center gap-2">
            <span class="text-lg" id="gradeDisplay">-</span>
            <span class="text-blue-100">‚Ä¢</span>
            <span class="text-lg" id="percentageDisplay">0%</span>
          </div>
        </div>

        <!-- Quick Stats -->
        <div class="grid grid-cols-3 gap-4 mt-6">
          <div class="bg-white bg-opacity-10 rounded-lg p-3 backdrop-blur-sm">
            <i class="fas fa-check-circle text-2xl mb-2"></i>
            <p class="text-2xl font-bold" id="correctCount">0</p>
            <p class="text-sm opacity-90">ƒê√∫ng</p>
          </div>
          <div class="bg-white bg-opacity-10 rounded-lg p-3 backdrop-blur-sm">
            <i class="fas fa-times-circle text-2xl mb-2"></i>
            <p class="text-2xl font-bold" id="wrongCount">0</p>
            <p class="text-sm opacity-90">Sai</p>
          </div>
          <div class="bg-white bg-opacity-10 rounded-lg p-3 backdrop-blur-sm">
            <i class="fas fa-clock text-2xl mb-2"></i>
            <p class="text-2xl font-bold" id="timeUsed">0m</p>
            <p class="text-sm opacity-90">Th·ªùi gian</p>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="flex flex-wrap gap-3 mb-6">
        <button onclick="toggleReview()" class="btn btn-primary flex-1">
          <i class="fas fa-list-alt"></i>
          Xem ƒë√°p √°n chi ti·∫øt
        </button>
        <button onclick="retakeExam()" class="btn btn-secondary flex-1">
          <i class="fas fa-redo"></i>
          L√†m l·∫°i
        </button>
        <button onclick="shareResult()" class="btn btn-outline">
          <i class="fas fa-share-alt"></i>
          Chia s·∫ª
        </button>
      </div>

      <!-- Detailed Stats -->
      <div class="grid md:grid-cols-2 gap-6 mb-6">
        <!-- Performance Chart -->
        <div class="card bg-white">
          <h3 class="font-semibold text-gray-900 mb-4">Ph√¢n t√≠ch k·∫øt qu·∫£</h3>
          <canvas id="performanceChart" height="200"></canvas>
        </div>

        <!-- Time Analysis -->
        <div class="card bg-white">
          <h3 class="font-semibold text-gray-900 mb-4">Th·ªëng k√™ th·ªùi gian</h3>
          <div class="space-y-4">
            <div class="flex justify-between items-center">
              <span class="text-gray-600">Th·ªùi gian cho ph√©p:</span>
              <span class="font-semibold" id="totalTime">0 ph√∫t</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-600">Th·ªùi gian ƒë√£ d√πng:</span>
              <span class="font-semibold text-blue-600" id="usedTime">0 ph√∫t</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-600">Th·ªùi gian c√≤n l·∫°i:</span>
              <span class="font-semibold text-green-600" id="remainingTime">0 ph√∫t</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-600">TB m·ªói c√¢u:</span>
              <span class="font-semibold" id="avgTimePerQuestion">0s</span>
            </div>
            <div class="pt-3 border-t border-gray-200">
              <div class="progress mb-2">
                <div class="progress-bar" id="timeProgressBar" style="width: 0%"></div>
              </div>
              <p class="text-xs text-gray-500 text-center">S·ª≠ d·ª•ng th·ªùi gian (<span id="timePercentageText">0</span>%)</p>
            </div>

            <!-- Recommendations inside Time Analysis -->
            <div class="pt-4 mt-4 border-t border-gray-200">
              <div class="bg-gradient-to-r from-purple-50 to-pink-50 border border-purple-200 rounded-lg p-4">
                <div class="flex items-start gap-3">
                  <div class="flex-shrink-0 w-10 h-10 bg-purple-500 rounded-lg flex items-center justify-center">
                    <i class="fas fa-lightbulb text-white text-lg"></i>
                  </div>
                  <div class="flex-1">
                    <h4 class="font-semibold text-purple-900 mb-2 text-sm">G·ª£i √Ω c·∫£i thi·ªán</h4>
                    <div id="recommendations" class="text-xs text-purple-800 space-y-1">
                      <!-- Will be populated by JavaScript -->
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Comparison -->
      <div class="card bg-white mb-6">
        <h3 class="font-semibold text-gray-900 mb-4">So s√°nh v·ªõi c√°c l·∫ßn tr∆∞·ªõc</h3>
        <div id="comparisonContainer">
          <canvas id="comparisonChart" height="100"></canvas>
        </div>
        <div id="noComparisonMessage" class="hidden text-center py-8 text-gray-500">
          <i class="fas fa-chart-line text-4xl mb-3 opacity-50"></i>
          <p>Ch∆∞a c√≥ l·∫ßn tr∆∞·ªõc ƒë·ªÉ so s√°nh</p>
          <p class="text-sm mt-1">L√†m l·∫°i b√†i n√†y ƒë·ªÉ xem ti·∫øn ƒë·ªô c·∫£i thi·ªán</p>
        </div>
      </div>

      <!-- Answer Review (Collapsible) -->
      <div id="reviewSection" class="hidden">
        <div class="card bg-white mb-6">
          <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-4">
            <h3 class="font-semibold text-gray-900 text-lg">
              <i class="fas fa-list-check text-blue-600 mr-2"></i>
              Chi ti·∫øt t·ª´ng c√¢u h·ªèi
            </h3>
            <div class="flex gap-2">
              <button onclick="filterReview('all')" class="filter-btn px-4 py-2 rounded-lg font-medium transition-all bg-blue-500 text-white" id="filterAll">
                <i class="fas fa-list mr-1"></i>
                T·∫•t c·∫£
              </button>
              <button onclick="filterReview('correct')" class="filter-btn px-4 py-2 rounded-lg font-medium transition-all bg-white text-green-600 border-2 border-green-500 hover:bg-green-50" id="filterCorrect">
                <i class="fas fa-check mr-1"></i>
                ƒê√∫ng
              </button>
              <button onclick="filterReview('wrong')" class="filter-btn px-4 py-2 rounded-lg font-medium transition-all bg-white text-red-600 border-2 border-red-500 hover:bg-red-50" id="filterWrong">
                <i class="fas fa-times mr-1"></i>
                Sai
              </button>
            </div>
          </div>

          <div id="reviewContent" class="space-y-3">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Scripts -->
  <script src="/tracnghiemluyenthi/public/assets/js/config.js"></script>
  <script src="/tracnghiemluyenthi/public/assets/js/utils.js"></script>
  <script src="/tracnghiemluyenthi/public/assets/js/api.js"></script>
  <script src="/tracnghiemluyenthi/public/assets/js/auth.js"></script>
  
  <script>
    // Require authentication
    if (!Auth.requireAuth()) {
      // Will redirect to login
    }

    // Get result ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const resultId = urlParams.get('result');

    if (!resultId) {
      Utils.showToast('Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ b√†i', 'error');
      setTimeout(() => window.location.href = '/tracnghiemluyenthi/public/pages/dashboard.html', 2000);
    }

    let resultData = null;
    let reviewFilter = 'all';

    // Load previous attempts for comparison
    async function loadPreviousAttempts() {
      try {
        // Get exam ID from current result
        const examId = resultData.examId?._id || resultData.examId;
        
        if (!examId) {
          console.log('No exam ID found for comparison');
          resultData.previousAttempts = [];
          return;
        }

        console.log('Loading previous attempts for exam:', examId);
        
        // Get all history for this user
        const historyResponse = await API.get('/quiz/history');
        const historyData = historyResponse.data || historyResponse;
        
        console.log('History data:', historyData);
        
        // Filter to get previous attempts of the same exam (excluding current one)
        const allAttempts = historyData.results || [];
        const previousAttempts = allAttempts
          .filter(attempt => {
            const attemptExamId = attempt.examId?._id || attempt.examId;
            const currentResultId = resultData._id;
            return attemptExamId === examId && attempt._id !== currentResultId;
          })
          .sort((a, b) => new Date(a.dateCompleted) - new Date(b.dateCompleted)) // Sort by date, oldest first
          .map(attempt => ({
            percentage: attempt.percentage,
            date: attempt.dateCompleted,
            score: attempt.score
          }));

        console.log('Previous attempts found:', previousAttempts.length);
        resultData.previousAttempts = previousAttempts;
        
      } catch (error) {
        console.error('Error loading previous attempts:', error);
        resultData.previousAttempts = [];
      }
    }

    // Load result
    async function loadResult() {
      try {
        Utils.showLoading('ƒêang t·∫£i k·∫øt qu·∫£...');

        console.log('Loading result ID:', resultId);
        const response = await API.get(`/quiz/results/${resultId}`);
        const data = response.data || response;
        
        console.log('Result data from API:', data);
        console.log('data.result.timeSpent:', data.result?.timeSpent);
        
        // Backend returns: {result: {...}, details: [...]}
        resultData = {
          ...data.result,
          details: data.details || [],
          exam: data.result.exam,
          subject: data.result.subject
        };

        console.log('Processed resultData:', resultData);
        console.log('resultData.timeSpent:', resultData.timeSpent);
        console.log('Details count:', resultData.details.length);

        // Load previous attempts for comparison chart
        await loadPreviousAttempts();

        displayResult();
        renderCharts();
        renderRecommendations();

        Utils.hideLoading();

        // Show confetti for high scores
        if (resultData.score >= 80) {
          showConfetti();
        }

      } catch (error) {
        console.error('Error loading result:', error);
        Utils.hideLoading();
        Utils.showToast('Kh√¥ng th·ªÉ t·∫£i k·∫øt qu·∫£. Chuy·ªÉn v·ªÅ trang l·ªãch s·ª≠...', 'error');
        setTimeout(() => {
          window.location.href = '/tracnghiemluyenthi/public/pages/history.html';
        }, 2000);
      }
    }

    // Display result
    function displayResult() {
      const { score, totalQuestions, correctAnswers, incorrectAnswers, timeSpent, percentage, exam, subject } = resultData;

      console.log('=== DISPLAY RESULT ===');
      console.log('timeSpent:', timeSpent);
      console.log('exam:', exam);
      console.log('exam.timeLimit:', exam?.timeLimit);
      console.log('exam.duration:', exam?.duration);

      // Update exam title
      const examTitle = exam?.type === 'practice' ? 'B√†i luy·ªán t·∫≠p' : 'B√†i ki·ªÉm tra';
      const subjectName = subject?.name || exam?.subject?.name || 'M√¥n h·ªçc';
      document.getElementById('examTitle').textContent = `${examTitle} - ${subjectName}`;

      // Use backend percentage (score is now percentage)
      const finalPercentage = score || percentage || Math.round((correctAnswers / totalQuestions) * 100);
      const grade = Utils.getGrade(finalPercentage);

      // Update displays
      document.getElementById('scoreDisplay').textContent = `${correctAnswers}/${totalQuestions}`;
      document.getElementById('gradeDisplay').textContent = grade.grade;
      document.getElementById('gradeDisplay').className = `text-lg ${grade.color}`;
      document.getElementById('percentageDisplay').textContent = `${Math.round(finalPercentage)}%`;

      document.getElementById('correctCount').textContent = correctAnswers;
      document.getElementById('wrongCount').textContent = incorrectAnswers;
      
      // Handle timeSpent (could be 0 or undefined)
      const validTimeSpent = timeSpent || 0;
      const minutes = Math.floor(validTimeSpent / 60);
      const seconds = validTimeSpent % 60;
      document.getElementById('timeUsed').textContent = validTimeSpent > 0 ? `${minutes}m ${seconds}s` : 'N/A';

      // Result title and icon based on score
      const resultIcon = document.getElementById('resultIcon');
      const resultTitle = document.getElementById('resultTitle');
      
      if (finalPercentage >= 80) {
        resultIcon.className = 'fas fa-trophy text-4xl text-yellow-300';
        resultTitle.textContent = 'Xu·∫•t s·∫Øc! üéâ';
      } else if (finalPercentage >= 60) {
        resultIcon.className = 'fas fa-star text-4xl';
        resultTitle.textContent = 'T·ªët l·∫Øm! üëç';
      } else if (finalPercentage >= 40) {
        resultIcon.className = 'fas fa-smile text-4xl';
        resultTitle.textContent = 'C·ªë g·∫Øng h∆°n n·ªØa! üí™';
      } else {
        resultIcon.className = 'fas fa-frown text-4xl';
        resultTitle.textContent = 'C·∫ßn √¥n t·∫≠p th√™m! üìö';
      }

      // Time stats
      const validTimeSpentForStats = timeSpent || 0;
      const durationInMinutes = exam?.timeLimit || exam?.duration || 30;
      const durationInSeconds = durationInMinutes * 60; // Convert to seconds
      
      // Used time
      const usedMinutes = Math.floor(validTimeSpentForStats / 60);
      const usedSeconds = validTimeSpentForStats % 60;
      
      // Remaining time
      const remainingTimeInSeconds = Math.max(0, durationInSeconds - validTimeSpentForStats);
      const remainingMinutes = Math.floor(remainingTimeInSeconds / 60);
      const remainingSeconds = remainingTimeInSeconds % 60;
      
      // Average time per question
      const avgTimePerQuestion = totalQuestions > 0 ? Math.round(validTimeSpentForStats / totalQuestions) : 0;
      
      // Time percentage
      const timePercentage = durationInSeconds > 0 ? Math.min(100, Math.round((validTimeSpentForStats / durationInSeconds) * 100)) : 0;

      console.log('=== TIME STATS ===');
      console.log('validTimeSpentForStats:', validTimeSpentForStats);
      console.log('durationInMinutes:', durationInMinutes);
      console.log('durationInSeconds:', durationInSeconds);
      console.log('usedMinutes:', usedMinutes, 'usedSeconds:', usedSeconds);
      console.log('remainingMinutes:', remainingMinutes, 'remainingSeconds:', remainingSeconds);
      console.log('avgTimePerQuestion:', avgTimePerQuestion);
      console.log('timePercentage:', timePercentage);

      // Format time as MM:SS
      const formatTime = (minutes, seconds) => {
        const mm = String(minutes).padStart(2, '0');
        const ss = String(seconds).padStart(2, '0');
        return `${mm}:${ss}`;
      };

      document.getElementById('totalTime').textContent = formatTime(durationInMinutes, 0);
      document.getElementById('usedTime').textContent = formatTime(usedMinutes, usedSeconds);
      document.getElementById('remainingTime').textContent = formatTime(remainingMinutes, remainingSeconds);
      document.getElementById('avgTimePerQuestion').textContent = `${avgTimePerQuestion}s`;
      document.getElementById('timeProgressBar').style.width = `${timePercentage}%`;
      document.getElementById('timePercentageText').textContent = timePercentage;
    }

    // Render charts
    function renderCharts() {
      // Performance chart (pie)
      const performanceCtx = document.getElementById('performanceChart').getContext('2d');
      new Chart(performanceCtx, {
        type: 'doughnut',
        data: {
          labels: ['ƒê√∫ng', 'Sai'],
          datasets: [{
            data: [resultData.correctAnswers, resultData.incorrectAnswers],
            backgroundColor: ['#10B981', '#EF4444']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });

      // Comparison chart (line)
      const attempts = resultData.previousAttempts || [];
      const currentPercentage = Math.round((resultData.correctAnswers / resultData.totalQuestions) * 100);
      
      console.log('=== COMPARISON CHART ===');
      console.log('Previous attempts:', attempts);
      console.log('Current percentage:', currentPercentage);
      
      // Check if there are previous attempts
      if (attempts.length === 0) {
        // Show message, hide chart
        document.getElementById('comparisonContainer').classList.add('hidden');
        document.getElementById('noComparisonMessage').classList.remove('hidden');
        return;
      }
      
      // Show chart, hide message
      document.getElementById('comparisonContainer').classList.remove('hidden');
      document.getElementById('noComparisonMessage').classList.add('hidden');
      
      // Create labels and data
      const labels = [...attempts.map((_, i) => `L·∫ßn ${i + 1}`), 'L·∫ßn n√†y'];
      const data = [...attempts.map(a => Math.round(a.percentage)), currentPercentage];
      
      console.log('Chart labels:', labels);
      console.log('Chart data:', data);
      
      const comparisonCtx = document.getElementById('comparisonChart').getContext('2d');
      new Chart(comparisonCtx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'ƒêi·ªÉm s·ªë (%)',
            data: data,
            borderColor: '#3B82F6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.4,
            fill: true,
            pointRadius: 5,
            pointHoverRadius: 7,
            pointBackgroundColor: '#3B82F6',
            pointBorderColor: '#fff',
            pointBorderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: {
                callback: function(value) {
                  return value + '%';
                }
              }
            }
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return 'ƒêi·ªÉm: ' + context.parsed.y + '%';
                }
              }
            }
          }
        }
      });
    }

    // Render recommendations
    function renderRecommendations() {
      const percentage = Math.round((resultData.correctAnswers / resultData.totalQuestions) * 100);
      const container = document.getElementById('recommendations');
      
      let recommendations = [];
      
      if (percentage >= 80) {
        recommendations = [
          '‚úì B·∫°n ƒë√£ l√†m r·∫•t t·ªët! H√£y th·ª≠ c√°c ƒë·ªÅ thi kh√≥ h∆°n.',
          '‚úì Duy tr√¨ phong ƒë·ªô b·∫±ng c√°ch luy·ªán t·∫≠p ƒë·ªÅu ƒë·∫∑n.',
          '‚úì Chia s·∫ª kinh nghi·ªám v·ªõi b·∫°n b√® ƒë·ªÉ c√πng ti·∫øn b·ªô.'
        ];
      } else if (percentage >= 60) {
        recommendations = [
          '‚Ä¢ √în t·∫≠p l·∫°i c√°c c√¢u h·ªèi ƒë√£ sai ƒë·ªÉ c·ªßng c·ªë ki·∫øn th·ª©c.',
          '‚Ä¢ L√†m th√™m c√°c b√†i t·∫≠p t∆∞∆°ng t·ª± ƒë·ªÉ n·∫Øm v·ªØng.',
          '‚Ä¢ Ph√¢n t√≠ch l·ªói sai ƒë·ªÉ tr√°nh l·∫∑p l·∫°i.'
        ];
      } else {
        recommendations = [
          '‚Ä¢ C·∫ßn √¥n t·∫≠p k·ªπ l∆∞·ª°ng ki·∫øn th·ª©c c∆° b·∫£n.',
          '‚Ä¢ L√†m l·∫°i ƒë·ªÅ n√†y sau khi ƒë√£ h·ªçc k·ªπ.',
          '‚Ä¢ Tham kh·∫£o t√†i li·ªáu v√† b√†i gi·∫£ng li√™n quan.',
          '‚Ä¢ Kh√¥ng n√™n n·∫£n ch√≠, h√£y c·ªë g·∫Øng h∆°n!'
        ];
      }
      
      container.innerHTML = recommendations.map(r => `<p>${r}</p>`).join('');
    }

    // Toggle review section
    function toggleReview() {
      const section = document.getElementById('reviewSection');
      
      if (section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        renderReview();
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
      } else {
        section.classList.add('hidden');
      }
    }

    // Render review
    function renderReview() {
      const container = document.getElementById('reviewContent');
      const details = resultData.details || [];

      const filteredDetails = details.filter(detail => {
        if (reviewFilter === 'correct') return detail.isCorrect;
        if (reviewFilter === 'wrong') return !detail.isCorrect;
        return true;
      });

      if (filteredDetails.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8 text-gray-500">
            <i class="fas fa-inbox text-4xl mb-3"></i>
            <p>Kh√¥ng c√≥ c√¢u h·ªèi n√†o</p>
          </div>
        `;
        return;
      }

      container.innerHTML = filteredDetails.map((detail, index) => {
        const isCorrect = detail.isCorrect;
        const options = detail.options || [];
        const userAnswer = detail.userAnswer || 'Kh√¥ng tr·∫£ l·ªùi';
        const correctAnswer = detail.correctAnswer || '';

        // Debug logging
        console.log(`Question ${index + 1}:`, {
          isCorrect,
          userAnswer,
          correctAnswer,
          options
        });

        return `
          <div class="border-2 rounded-lg p-4 mb-3 ${isCorrect ? 'border-green-500 bg-green-50' : 'border-red-500 bg-red-50'}">
            <div class="flex items-center justify-between mb-3">
              <h4 class="font-semibold text-gray-900 text-lg">
                <i class="fas fa-${isCorrect ? 'check-circle text-green-600' : 'times-circle text-red-600'} mr-2"></i>
                C√¢u ${index + 1}
              </h4>
              <span class="px-3 py-1 rounded-full text-sm font-semibold flex items-center justify-center ${isCorrect ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}">
                ${isCorrect ? '‚úì ƒê√∫ng' : '‚úó Sai'}
              </span>
            </div>

            <div class="mb-4 p-3 bg-white rounded-lg border border-gray-200">
              <p class="text-gray-900 font-medium">${detail.content}</p>
            </div>

            <div class="space-y-2">
              ${options.map((opt, i) => {
                const optText = typeof opt === 'string' ? opt : opt.text || opt;
                const optTextClean = (optText || '').toString().trim();
                const userAnswerClean = (userAnswer || '').toString().trim();
                const correctAnswerClean = (correctAnswer || '').toString().trim();
                
                const isUserAnswer = optTextClean === userAnswerClean;
                const isCorrectAnswer = optTextClean === correctAnswerClean;
                
                // Debug each option comparison
                if (i === 0) {
                  console.log('Comparing for question:', detail.content.substring(0, 50));
                  console.log('User Answer (clean):', userAnswerClean);
                  console.log('Correct Answer (clean):', correctAnswerClean);
                }
                console.log(`  Option ${i}: "${optTextClean}" | isUser: ${isUserAnswer}, isCorrect: ${isCorrectAnswer}`);
                
                let className = 'p-3 rounded-lg border-2 transition-all ';
                let icon = '';
                let label = '';
                
                if (isCorrectAnswer && isUserAnswer) {
                  // User ch·ªçn ƒë√∫ng
                  className += 'border-green-500 bg-green-100';
                  icon = '<i class="fas fa-check-circle text-green-600 text-xl"></i>';
                } else if (isCorrectAnswer) {
                  // ƒê√°p √°n ƒë√∫ng nh∆∞ng user kh√¥ng ch·ªçn
                  className += 'border-green-500 bg-green-50';
                  icon = '<i class="fas fa-check-circle text-green-600 text-xl"></i>';
                } else if (isUserAnswer) {
                  // User ch·ªçn sai
                  className += 'border-red-500 bg-red-100';
                  icon = '<i class="fas fa-times-circle text-red-600 text-xl"></i>';
                } else {
                  // C√°c ƒë√°p √°n kh√°c
                  className += 'border-gray-300 bg-gray-50 opacity-60';
                }

                return `
                  <div class="${className}">
                    <div class="flex items-start gap-3">
                      <div class="flex-shrink-0 mt-1">${icon}</div>
                      <div class="flex-1">
                        <span class="font-semibold text-gray-700 mr-2">${String.fromCharCode(65 + i)}.</span>
                        <span class="text-gray-900">${optText}</span>
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>



            ${detail.explanation ? `
              <div class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                <p class="text-sm font-semibold text-blue-900 mb-1">
                  <i class="fas fa-lightbulb"></i> Gi·∫£i th√≠ch:
                </p>
                <p class="text-sm text-blue-800">${detail.explanation}</p>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    // Filter review
    function filterReview(filter) {
      reviewFilter = filter;
      
      // Update button styles
      const allBtn = document.getElementById('filterAll');
      const correctBtn = document.getElementById('filterCorrect');
      const wrongBtn = document.getElementById('filterWrong');
      
      // Reset all buttons
      allBtn.className = 'filter-btn px-4 py-2 rounded-lg font-medium transition-all bg-white text-blue-600 border-2 border-blue-500 hover:bg-blue-50';
      correctBtn.className = 'filter-btn px-4 py-2 rounded-lg font-medium transition-all bg-white text-green-600 border-2 border-green-500 hover:bg-green-50';
      wrongBtn.className = 'filter-btn px-4 py-2 rounded-lg font-medium transition-all bg-white text-red-600 border-2 border-red-500 hover:bg-red-50';
      
      // Set active button
      if (filter === 'all') {
        allBtn.className = 'filter-btn px-4 py-2 rounded-lg font-medium transition-all bg-blue-500 text-white border-2 border-blue-500';
      } else if (filter === 'correct') {
        correctBtn.className = 'filter-btn px-4 py-2 rounded-lg font-medium transition-all bg-green-500 text-white border-2 border-green-500';
      } else if (filter === 'wrong') {
        wrongBtn.className = 'filter-btn px-4 py-2 rounded-lg font-medium transition-all bg-red-500 text-white border-2 border-red-500';
      }
      
      renderReview();
    }

    // Retake exam
    function retakeExam() {
      console.log('=== RETAKE EXAM ===');
      console.log('resultData:', resultData);
      console.log('resultData.exam:', resultData.exam);
      console.log('resultData.examId:', resultData.examId);
      
      // Try to get exam ID from multiple possible locations
      const examId = resultData.exam?._id || resultData.exam?.id || resultData.examId?._id || resultData.examId;
      
      console.log('Exam ID:', examId);
      
      if (!examId) {
        alert('Kh√¥ng t√¨m th·∫•y ID b√†i. Vui l√≤ng th·ª≠ l·∫°i.');
        return;
      }
      
      if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën l√†m l·∫°i b√†i n√†y?')) {
        const url = `/tracnghiemluyenthi/public/pages/quiz.html?exam=${examId}`;
        console.log('Redirecting to:', url);
        window.location.href = url;
      }
    }

    // Share result
    function shareResult() {
      const percentage = Math.round((resultData.correctAnswers / resultData.totalQuestions) * 100);
      const text = `T√¥i v·ª´a ƒë·∫°t ${percentage}% trong b√†i"${resultData.exam?.title}" tr√™n Techie! üéâ`;
      
      if (navigator.share) {
        navigator.share({
          title: 'K·∫øt qu·∫£ thi - Techie',
          text: text
        });
      } else {
        Utils.copyToClipboard(text);
      }
    }

    // Show confetti animation
    function showConfetti() {
      const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F'];
      
      for (let i = 0; i < 50; i++) {
        setTimeout(() => {
          const confetti = document.createElement('div');
          confetti.className = 'confetti';
          confetti.style.left = Math.random() * 100 + '%';
          confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
          confetti.style.animationDelay = Math.random() * 0.5 + 's';
          document.body.appendChild(confetti);
          
          setTimeout(() => confetti.remove(), 3000);
        }, i * 50);
      }
    }

    // Initialize
    loadResult();
  </script>
</body>
</html>
