<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ƒê·ªÅ thi - Techie</title>
  
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Custom CSS -->
  <link rel="stylesheet" href="/tracnghiemluyenthi/public/assets/css/main.css">
  <link rel="stylesheet" href="/tracnghiemluyenthi/public/assets/css/components.css">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50">
  <!-- Navigation -->
  <nav class="bg-white shadow-sm sticky top-0 z-40">
    <div class="container mx-auto px-4">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center space-x-2">
          <i class="fas fa-graduation-cap text-2xl text-blue-600"></i>
          <span class="text-xl font-bold text-gray-800">Techie</span>
        </div>

        <div class="hidden md:flex items-center space-x-6">
          <a href="/tracnghiemluyenthi/public/pages/dashboard.html" class="text-gray-600 hover:text-blue-600 transition flex items-center gap-2">
            <i class="fas fa-home"></i>
            Dashboard
          </a>
          <a href="/tracnghiemluyenthi/public/pages/subjects.html" class="text-gray-600 hover:text-blue-600 transition flex items-center gap-2">
            <i class="fas fa-book"></i>
            M√¥n h·ªçc
          </a>
          <a href="/tracnghiemluyenthi/public/pages/history.html" class="text-gray-600 hover:text-blue-600 transition flex items-center gap-2">
            <i class="fas fa-history"></i>
            L·ªãch s·ª≠
          </a>
        </div>

        <div class="flex items-center space-x-4">
          <button class="relative text-gray-600 hover:text-blue-600 transition">
            <i class="fas fa-bell text-xl"></i>
            <span class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white text-xs rounded-full flex items-center justify-center">3</span>
          </button>

          <div class="relative">
            <button id="userMenuBtn" class="flex items-center space-x-2 hover:bg-gray-100 rounded-lg px-3 py-2 transition">
              <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white font-semibold">
                <span id="userInitial">U</span>
              </div>
              <span class="hidden md:block text-gray-700 font-medium" id="userName">User</span>
              <i class="fas fa-chevron-down text-gray-500 text-sm"></i>
            </button>

            <div id="userMenu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg py-2 z-50">
              <a href="/tracnghiemluyenthi/public/pages/profile.html" class="block px-4 py-2 text-gray-700 hover:bg-gray-100 transition">
                <i class="fas fa-user mr-2"></i>
                H·ªì s∆°
              </a>
              <a href="/tracnghiemluyenthi/public/pages/settings.html" class="block px-4 py-2 text-gray-700 hover:bg-gray-100 transition">
                <i class="fas fa-cog mr-2"></i>
                C√†i ƒë·∫∑t
              </a>
              <hr class="my-2">
              <button id="logoutBtn" class="w-full text-left px-4 py-2 text-red-600 hover:bg-red-50 transition">
                <i class="fas fa-sign-out-alt mr-2"></i>
                ƒêƒÉng xu·∫•t
              </button>
            </div>
          </div>

          <button id="mobileMenuBtn" class="md:hidden text-gray-600">
            <i class="fas fa-bars text-xl"></i>
          </button>
        </div>
      </div>

      <div id="mobileMenu" class="hidden md:hidden border-t border-gray-200 py-4">
        <a href="/tracnghiemluyenthi/public/pages/dashboard.html" class="block py-2 text-gray-600 hover:text-blue-600">
          <i class="fas fa-home mr-2"></i>
          Dashboard
        </a>
        <a href="/tracnghiemluyenthi/public/pages/subjects.html" class="block py-2 text-gray-600 hover:text-blue-600">
          <i class="fas fa-book mr-2"></i>
          M√¥n h·ªçc
        </a>
        <a href="/tracnghiemluyenthi/public/pages/exams.html" class="block py-2 text-blue-600 font-semibold">
          <i class="fas fa-file-alt mr-2"></i>
          ƒê·ªÅ thi
        </a>
        <a href="/tracnghiemluyenthi/public/pages/history.html" class="block py-2 text-gray-600 hover:text-blue-600">
          <i class="fas fa-history mr-2"></i>
          L·ªãch s·ª≠
        </a>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="container mx-auto px-4 py-6">
    <!-- Breadcrumb -->
    <div class="flex items-center gap-2 text-sm text-gray-600 mb-6">
      <a href="/tracnghiemluyenthi/public/pages/dashboard.html" class="hover:text-blue-600">Dashboard</a>
      <i class="fas fa-chevron-right text-xs"></i>
      <a href="/tracnghiemluyenthi/public/pages/subjects.html" class="hover:text-blue-600">M√¥n h·ªçc</a>
      <i class="fas fa-chevron-right text-xs"></i>
      <span class="text-gray-900 font-medium" id="subjectName">ƒê·ªÅ thi</span>
    </div>

    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold text-gray-900 mb-2">
          <i class="fas fa-book-open text-blue-600"></i>
          <span id="subjectTitle">M√¥n h·ªçc</span>
        </h1>
        <p class="text-gray-600" id="subjectDescription">T·∫°o quiz m·ªõi ho·∫∑c xem l·∫°i quiz ƒë√£ l√†m</p>
      </div>

      <div class="flex gap-2">
        <button onclick="window.location.href = '/tracnghiemluyenthi/public/pages/subjects.html'" class="btn btn-secondary">
          <i class="fas fa-arrow-left"></i>
          Quay l·∫°i
        </button>
      </div>
    </div>

    <!-- Create New Quiz Section -->
    <div class="card bg-gradient-to-br from-blue-500 to-blue-600 text-white mb-6">
      <div class="flex flex-col md:flex-row items-center gap-6">
        <div class="flex-shrink-0">
          <div class="w-20 h-20 bg-white/20 rounded-full flex items-center justify-center">
            <i class="fas fa-graduation-cap text-4xl"></i>
          </div>
        </div>
        <div class="flex-1 text-center md:text-left">
          <h2 class="text-2xl font-bold mb-2">√în luy·ªán & Thi th·ª≠</h2>
          <p class="text-blue-100 mb-4">Xem ng√¢n h√†ng c√¢u h·ªèi ƒë·ªÉ √¥n t·∫≠p ho·∫∑c l√†m b√†i thi th·ª≠ ƒë·ªÉ ƒë√°nh gi√° nƒÉng l·ª±c</p>
          <div class="flex flex-wrap gap-3 justify-center md:justify-start">
            <button onclick="showQuestionBankModal()" class="btn bg-white/10 hover:bg-white/20 text-white border-2 border-white font-semibold">
              <i class="fas fa-database"></i>
              Xem ng√¢n h√†ng c√¢u h·ªèi
            </button>
            <button onclick="showCreateExamModal()" class="btn bg-white text-blue-600 hover:bg-blue-50 font-semibold">
              <i class="fas fa-play-circle"></i>
              Luy·ªán thi ngay
            </button>
          </div>
        </div>
        <div class="hidden md:block">
          <div class="text-center">
            <div class="text-3xl font-bold mb-1" id="totalQuestionsLarge">0</div>
            <div class="text-sm text-blue-100">C√¢u h·ªèi c√≥ s·∫µn</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Quiz History Section -->
    <div class="mb-4">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h2 class="text-xl font-bold text-gray-900 mb-1">
            <i class="fas fa-history text-gray-600"></i>
            Quiz ƒë√£ l√†m - <span id="historySubjectName" class="text-blue-600">...</span>
          </h2>
          <p class="text-sm text-gray-500">L·ªãch s·ª≠ c√°c quiz b·∫°n ƒë√£ ho√†n th√†nh</p>
        </div>
        <div class="flex items-center gap-2">
          <div class="text-center px-3 py-2 bg-blue-50 rounded-lg">
            <div class="text-xs text-gray-600">T·ªïng quiz</div>
            <div class="text-lg font-bold text-blue-600" id="totalExams">0</div>
          </div>
          <div class="text-center px-3 py-2 bg-green-50 rounded-lg">
            <div class="text-xs text-gray-600">ƒêi·ªÉm TB</div>
            <div class="text-lg font-bold text-green-600" id="avgScore">0%</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Exams List -->
    <div id="examsList" class="space-y-3">
      <!-- Loading skeleton -->
      <div class="card bg-white animate-pulse">
        <div class="flex items-start gap-4">
          <div class="w-12 h-12 bg-gray-300 rounded-lg"></div>
          <div class="flex-1">
            <div class="h-4 bg-gray-300 rounded w-3/4 mb-2"></div>
            <div class="h-3 bg-gray-300 rounded w-1/2"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="hidden text-center py-12">
      <div class="max-w-md mx-auto">
        <i class="fas fa-clipboard-list text-6xl text-gray-300 mb-4"></i>
        <h3 class="text-xl font-semibold text-gray-700 mb-2">Ch∆∞a c√≥ quiz n√†o</h3>
        <p class="text-gray-500 mb-1">B·∫°n ch∆∞a l√†m quiz n√†o cho m√¥n</p>
        <p class="text-blue-600 font-semibold text-lg mb-4" id="emptySubjectName">...</p>
        <button onclick="showCreateExamModal()" class="btn btn-primary">
          <i class="fas fa-plus"></i>
          T·∫°o quiz ƒë·∫ßu ti√™n
        </button>
      </div>
    </div>
  </main>

  <!-- Create Exam Modal (Luy·ªán thi with settings) -->
  <div id="createExamModal" class="hidden modal-overlay" onclick="closeCreateExamModal()">
    <div class="modal-content max-w-2xl" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">
          <i class="fas fa-play-circle text-blue-600 mr-2"></i>
          Luy·ªán thi ngay
        </h2>
        <button class="modal-close" onclick="closeCreateExamModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="modal-body space-y-4">
        <!-- Number of Questions -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            <i class="fas fa-list-ol mr-1"></i>S·ªë c√¢u h·ªèi
          </label>
          <input 
            type="number" 
            id="practiceQuestionCount" 
            class="form-input w-full" 
            min="1" 
            max="100" 
            value="5"
            placeholder="Nh·∫≠p s·ªë c√¢u h·ªèi"
          >
          <p class="text-xs text-gray-500 mt-1">
            T·ªëi ƒëa: <span id="maxPracticeQuestions" class="font-semibold text-blue-600">0</span> c√¢u
          </p>
        </div>

        <!-- Overall Timer -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            <i class="fas fa-hourglass-half mr-1"></i>Th·ªùi gian l√†m b√†i (ph√∫t)
          </label>
          <select id="practiceTimeLimit" class="form-input w-full">
            <option value="0">Kh√¥ng gi·ªõi h·∫°n</option>
            <option value="5">5 ph√∫t</option>
            <option value="10">10 ph√∫t</option>
            <option value="15">15 ph√∫t</option>
            <option value="20">20 ph√∫t</option>
            <option value="30">30 ph√∫t</option>
            <option value="45">45 ph√∫t</option>
            <option value="60">60 ph√∫t</option>
          </select>
        </div>

        <!-- Settings Grid -->
        <div class="bg-gray-50 rounded-lg p-4 space-y-3">
          <h4 class="font-semibold text-gray-800 mb-3">
            <i class="fas fa-cog mr-2"></i>C√†i ƒë·∫∑t
          </h4>

          <!-- Timer per Question -->
          <div class="flex items-center justify-between p-3 bg-white rounded-lg border border-gray-200">
            <div class="flex items-center gap-3 flex-1">
              <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-stopwatch text-purple-600"></i>
              </div>
              <div class="flex-1">
                <p class="font-medium text-gray-900">ƒê·∫øm ng∆∞·ª£c m·ªói c√¢u</p>
                <p class="text-sm text-gray-500">Gi·ªõi h·∫°n th·ªùi gian cho t·ª´ng c√¢u h·ªèi</p>
                <p class="text-xs text-purple-600 font-semibold mt-1" id="timePerQuestionInfo" style="display: none;">
                  <i class="fas fa-info-circle mr-1"></i>
                  <span id="timePerQuestionText"></span>
                </p>
              </div>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" id="timerPerQuestion" class="sr-only peer" onchange="updateTimePerQuestionInfo()">
              <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
            </label>
          </div>

          <!-- Background Music -->
          <div class="flex items-center justify-between p-3 bg-white rounded-lg border border-gray-200">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-music text-green-600"></i>
              </div>
              <div>
                <p class="font-medium text-gray-900">Nh·∫°c n·ªÅn</p>
                <p class="text-sm text-gray-500">Ph√°t nh·∫°c n·ªÅn trong khi l√†m b√†i</p>
              </div>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" id="backgroundMusic" class="sr-only peer">
              <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
            </label>
          </div>

          <!-- Sound Effects -->
          <div class="flex items-center justify-between p-3 bg-white rounded-lg border border-gray-200">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-yellow-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-volume-up text-yellow-600"></i>
              </div>
              <div>
                <p class="font-medium text-gray-900">Hi·ªáu ·ª©ng √¢m thanh</p>
                <p class="text-sm text-gray-500">√Çm thanh khi tr·∫£ l·ªùi ƒë√∫ng/sai</p>
              </div>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" id="soundEffects" class="sr-only peer">
              <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
            </label>
          </div>
        </div>

        <div id="createError" class="hidden text-sm text-red-600 bg-red-50 border border-red-200 rounded-lg p-3">
          <i class="fas fa-exclamation-circle mr-2"></i>
          <span id="createErrorMessage"></span>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeCreateExamModal()">H·ªßy</button>
        <button class="btn btn-primary" onclick="createAndStartExam()" id="createExamBtn">
          <i class="fas fa-play"></i>
          B·∫Øt ƒë·∫ßu luy·ªán thi
        </button>
      </div>
    </div>
  </div>

  <!-- Question Bank Modal -->
  <div id="questionBankModal" class="hidden modal-overlay" onclick="closeQuestionBankModal()">
    <div class="modal-content max-w-4xl max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
      <div class="modal-header sticky top-0 bg-white z-10">
        <h2 class="modal-title">
          <i class="fas fa-database text-blue-600 mr-2"></i>
          Ng√¢n h√†ng c√¢u h·ªèi - <span id="questionBankSubjectName" class="text-blue-600">...</span>
        </h2>
        <button class="modal-close" onclick="closeQuestionBankModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="modal-body">
        <!-- Filter Section -->
        <div class="flex flex-wrap gap-3 mb-6 pb-4 border-b">
          <div class="flex-1 min-w-[200px]">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fas fa-filter mr-1"></i>ƒê·ªô kh√≥
            </label>
            <select id="difficultyFilter" class="form-input w-full" onchange="filterQuestions()">
              <option value="all">T·∫•t c·∫£</option>
              <option value="easy">D·ªÖ</option>
              <option value="medium">Trung b√¨nh</option>
              <option value="hard">Kh√≥</option>
            </select>
          </div>
          <div class="flex-1 min-w-[200px]">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fas fa-question-circle mr-1"></i>Lo·∫°i c√¢u h·ªèi
            </label>
            <select id="typeFilter" class="form-input w-full" onchange="filterQuestions()">
              <option value="all">T·∫•t c·∫£</option>
              <option value="multiple_choice">Tr·∫Øc nghi·ªám</option>
              <option value="true_false">ƒê√∫ng/Sai</option>
            </select>
          </div>
          <div class="flex items-end">
            <div class="text-center px-4 py-2 bg-blue-50 rounded-lg">
              <div class="text-xs text-gray-600">T·ªïng c√¢u h·ªèi</div>
              <div class="text-lg font-bold text-blue-600" id="questionBankTotal">0</div>
            </div>
          </div>
        </div>

        <!-- Questions List -->
        <div id="questionBankList" class="space-y-4">
          <div class="text-center py-8">
            <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-3"></i>
            <p class="text-gray-600">ƒêang t·∫£i c√¢u h·ªèi...</p>
          </div>
        </div>
      </div>

      <div class="modal-footer sticky bottom-0 bg-white border-t">
        <button class="btn btn-secondary" onclick="closeQuestionBankModal()">ƒê√≥ng</button>
        <button class="btn btn-primary" onclick="closeQuestionBankModal(); showCreateExamModal();">
          <i class="fas fa-play"></i>
          B·∫Øt ƒë·∫ßu luy·ªán thi
        </button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="/tracnghiemluyenthi/public/assets/js/config.js"></script>
  <script src="/tracnghiemluyenthi/public/assets/js/utils.js"></script>
  <script src="/tracnghiemluyenthi/public/assets/js/api.js"></script>
  <script src="/tracnghiemluyenthi/public/assets/js/auth.js"></script>
  
  <script>
    // Require authentication
    if (!Auth.requireAuth()) {
      // Will redirect to login
    }

    // Get current user and update header
    const currentUser = Auth.getCurrentUser();
    if (currentUser) {
      Utils.updateHeaderUser();
    }

    // Toggle user menu
    const userMenuBtn = document.getElementById('userMenuBtn');
    const userMenu = document.getElementById('userMenu');
    
    userMenuBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      userMenu.classList.toggle('hidden');
    });

    document.addEventListener('click', () => {
      userMenu.classList.add('hidden');
    });

    // Toggle mobile menu
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const mobileMenu = document.getElementById('mobileMenu');
    mobileMenuBtn.addEventListener('click', () => {
      mobileMenu.classList.toggle('hidden');
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', () => {
      if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
        Auth.logout();
      }
    });

    // Get subject from URL
    const urlParams = new URLSearchParams(window.location.search);
    const subjectId = urlParams.get('subject');

    // State
    let allExams = [];
    let filteredExams = [];
    let currentSubject = null;

    // Load subject info and stats
    async function loadSubjectInfo() {
      try {
        if (!subjectId) {
          console.error('No subject ID provided');
          window.location.href = '/tracnghiemluyenthi/public/pages/subjects.html';
          return;
        }

        console.log('Loading subject with ID:', subjectId);
        const response = await API.get(`/subjects/${subjectId}`);
        console.log('Subject API response:', response);
        
        // Try multiple ways to get subject from response
        currentSubject = response.data?.subject || response.subject || response.data;
        
        console.log('Current subject loaded:', currentSubject);
        
        if (!currentSubject || !currentSubject.name) {
          console.error('Subject data invalid:', currentSubject);
          throw new Error('Kh√¥ng t√¨m th·∫•y th√¥ng tin m√¥n h·ªçc');
        }

        // Update all subject name elements with null checks
        const updateElement = (id, value) => {
          const element = document.getElementById(id);
          if (element) {
            element.textContent = value;
          } else {
            console.warn(`Element with id '${id}' not found`);
          }
        };

        updateElement('subjectName', currentSubject.name);
        updateElement('subjectTitle', currentSubject.name);
        updateElement('subjectNameInline', currentSubject.name);
        updateElement('emptySubjectName', currentSubject.name);
        updateElement('historySubjectName', currentSubject.name);
        updateElement('subjectDescription', currentSubject.description || 'Xem ng√¢n h√†ng c√¢u h·ªèi ƒë·ªÉ √¥n t·∫≠p ho·∫∑c l√†m b√†i thi th·ª≠');
        updateElement('totalQuestionsLarge', currentSubject.questionCount || 0);
        
        // Update page title
        document.title = `${currentSubject.name} - Techie`;

        // Load exam history stats
        await loadExamStats();
      } catch (error) {
        console.error('Error loading subject info:', error);
        console.error('Error details:', error.message, error.response);
        
        // Show more detailed error message
        const errorMsg = error.response?.data?.message || error.message || 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin m√¥n h·ªçc';
        alert(`${errorMsg}\n\nVui l√≤ng ki·ªÉm tra:\n- Server ƒë√£ ch·∫°y ch∆∞a?\n- Subject ID c√≥ ƒë√∫ng kh√¥ng?`);
        
        // Don't redirect immediately, let user see the error
        // window.location.href = '/tracnghiemluyenthi/public/pages/subjects.html';
      }
    }

    // Load exam statistics
    async function loadExamStats() {
      try {
        const endpoint = subjectId ? `/quiz/history?subjectId=${subjectId}` : '/quiz/history';
        console.log('üìä Loading stats from:', endpoint);
        
        const response = await API.get(endpoint);
        console.log('üìä Stats response:', response);
        console.log('üìä Stats data:', response.data);
        console.log('üìä Stats object:', response.data?.stats);
        
        const stats = response.data?.stats || {};
        
        const totalExamsEl = document.getElementById('totalExams');
        const avgScoreEl = document.getElementById('avgScore');
        
        console.log('üìä Total exams:', stats.totalExams);
        console.log('üìä Average score:', stats.averageScore);
        
        if (totalExamsEl) totalExamsEl.textContent = stats.totalExams || 0;
        if (avgScoreEl) avgScoreEl.textContent = stats.averageScore 
          ? Math.round(stats.averageScore) + '%' 
          : '0%';
          
        console.log('‚úÖ Stats updated successfully');
      } catch (error) {
        console.error('‚ùå Error loading stats:', error);
        console.error('Error message:', error.message);
        console.error('Error response:', error.response);
      }
    }

    // Load exams (user's quiz history for this subject)
    async function loadExams() {
      try {
        const endpoint = subjectId 
          ? `/quiz/history?subjectId=${subjectId}&limit=50` 
          : '/quiz/history?limit=50';
        
        console.log('Loading quiz history for subject:', subjectId);
        console.log('API endpoint:', endpoint);
        
        const response = await API.get(endpoint);
        allExams = response.data?.results || response.results || [];
        filteredExams = [...allExams];

        console.log('Loaded quiz history:', allExams.length, 'results');
        
        renderExams();
      } catch (error) {
        console.error('Error loading exams:', error);
        allExams = [];
        filteredExams = [];
        renderExams();
      }
    }

    // Render exams (quiz history)
    function renderExams() {
      const container = document.getElementById('examsList');
      const emptyState = document.getElementById('emptyState');

      if (filteredExams.length === 0) {
        container.innerHTML = '';
        container.classList.add('hidden');
        emptyState.classList.remove('hidden');
        return;
      }

      container.classList.remove('hidden');
      emptyState.classList.add('hidden');

      container.innerHTML = filteredExams.map(result => {
        const score = result.score || 0;
        const scoreColor = getScoreColor(score);
        const passed = score >= 50;
        
        return `
        <div class="card bg-white hover:shadow-lg transition-all duration-300 cursor-pointer" onclick="viewResult('${result._id}')">
          <div class="flex items-center gap-4">
            <!-- Score Badge -->
            <div class="flex-shrink-0">
              <div class="w-16 h-16 ${passed ? 'bg-green-100' : 'bg-red-100'} rounded-lg flex items-center justify-center">
                <div class="text-center">
                  <div class="text-2xl font-bold ${scoreColor}">${score}%</div>
                </div>
              </div>
            </div>

            <!-- Quiz Info -->
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1">
                <i class="fas fa-${passed ? 'check-circle text-green-600' : 'times-circle text-red-600'}"></i>
                <span class="font-semibold text-gray-900">${passed ? 'ƒê·∫°t' : 'Ch∆∞a ƒë·∫°t'}</span>
                <span class="text-gray-400">‚Ä¢</span>
                <span class="text-sm text-gray-600">${Utils.formatDate(result.completedAt || result.createdAt, 'DD/MM/YYYY HH:mm')}</span>
              </div>

              <div class="flex flex-wrap items-center gap-3 text-sm text-gray-600">
                <div class="flex items-center gap-1">
                  <i class="fas fa-check-circle text-green-600"></i>
                  <span>${result.correctAnswers || 0} ƒë√∫ng</span>
                </div>
                <div class="flex items-center gap-1">
                  <i class="fas fa-times-circle text-red-600"></i>
                  <span>${result.wrongAnswers || 0} sai</span>
                </div>
                <div class="flex items-center gap-1">
                  <i class="fas fa-question-circle text-gray-400"></i>
                  <span>${result.totalQuestions || 0} c√¢u</span>
                </div>
                ${result.timeTaken ? `
                  <div class="flex items-center gap-1">
                    <i class="fas fa-clock text-blue-600"></i>
                    <span>${Math.floor(result.timeTaken / 60)}:${String(result.timeTaken % 60).padStart(2, '0')}</span>
                  </div>
                ` : ''}
              </div>
            </div>

            <!-- Action Button -->
            <div class="flex items-center gap-2">
              <button 
                class="btn btn-sm btn-primary"
                onclick="event.stopPropagation(); viewResult('${result._id}')"
              >
                <i class="fas fa-eye"></i>
                Xem chi ti·∫øt
              </button>
            </div>
          </div>
        </div>
      `;
      }).join('');
    }

    // View quiz result
    function viewResult(resultId) {
      window.location.href = `/tracnghiemluyenthi/public/pages/results.html?result=${resultId}`;
    }

    // Get score color (kept for compatibility)
    function getScoreColor(score) {
      if (score >= 80) return 'text-green-600';
      if (score >= 60) return 'text-blue-600';
      if (score >= 40) return 'text-yellow-600';
      return 'text-red-600';
    }

    // Show exam details
    function showExamDetails(examId) {
      const exam = filteredExams.find(e => e._id === examId);
      if (!exam) return;

      document.getElementById('modalTitle').textContent = exam.title;
      document.getElementById('modalContent').innerHTML = `
        <div class="space-y-4">
          <div>
            <h4 class="font-semibold text-gray-900 mb-2">M√¥ t·∫£:</h4>
            <p class="text-gray-600">${exam.description || 'Kh√¥ng c√≥ m√¥ t·∫£'}</p>
          </div>

          <div class="grid md:grid-cols-2 gap-4">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-question-circle text-blue-600"></i>
              </div>
              <div>
                <p class="text-sm text-gray-600">S·ªë c√¢u h·ªèi</p>
                <p class="font-semibold text-gray-900">${exam.totalQuestions || 0} c√¢u</p>
              </div>
            </div>

            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-clock text-green-600"></i>
              </div>
              <div>
                <p class="text-sm text-gray-600">Th·ªùi gian</p>
                <p class="font-semibold text-gray-900">${exam.duration || 0} ph√∫t</p>
              </div>
            </div>

            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-chart-bar text-purple-600"></i>
              </div>
              <div>
                <p class="text-sm text-gray-600">ƒê·ªô kh√≥</p>
                <p class="font-semibold text-gray-900">${getDifficultyText(exam.difficulty)}</p>
              </div>
            </div>

            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-users text-orange-600"></i>
              </div>
              <div>
                <p class="text-sm text-gray-600">L∆∞·ª£t thi</p>
                <p class="font-semibold text-gray-900">${exam.totalAttempts || 0}</p>
              </div>
            </div>
          </div>

          ${exam.hasDone ? `
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i>
              <div>
                <p class="font-semibold">B·∫°n ƒë√£ l√†m b√†i thi n√†y</p>
                <p>ƒêi·ªÉm s·ªë: <span class="font-bold">${exam.lastScore}%</span> - ${Utils.formatDate(exam.lastAttempt, 'DD/MM/YYYY HH:mm')}</p>
              </div>
            </div>
          ` : ''}

          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <div>
              <p class="font-semibold">L∆∞u √Ω:</p>
              <ul class="text-sm mt-1 space-y-1">
                <li>‚Ä¢ Kh√¥ng ƒë∆∞·ª£c tho√°t ra ngo√†i trong khi l√†m b√†i</li>
                <li>‚Ä¢ B√†i thi s·∫Ω t·ª± ƒë·ªông n·ªôp khi h·∫øt gi·ªù</li>
                <li>‚Ä¢ M·ªói c√¢u h·ªèi ch·ªâ ƒë∆∞·ª£c ch·ªçn 1 ƒë√°p √°n</li>
              </ul>
            </div>
          </div>
        </div>
      `;

      document.getElementById('startExamBtn').onclick = () => {
        closeExamModal();
        startExam(examId);
      };

      document.getElementById('examModal').classList.remove('hidden');
    }

    function closeExamModal() {
      document.getElementById('examModal').classList.add('hidden');
    }

    // Update time per question info display
    function updateTimePerQuestionInfo() {
      const timerPerQuestion = document.getElementById('timerPerQuestion').checked;
      const timeLimit = parseInt(document.getElementById('practiceTimeLimit').value) || 0;
      const questionCount = parseInt(document.getElementById('practiceQuestionCount').value) || 5;
      const infoElement = document.getElementById('timePerQuestionInfo');
      const textElement = document.getElementById('timePerQuestionText');

      if (timerPerQuestion && timeLimit > 0) {
        const timePerQuestion = Math.floor((timeLimit * 60) / questionCount);
        const minutes = Math.floor(timePerQuestion / 60);
        const seconds = timePerQuestion % 60;
        
        let timeText = '';
        if (minutes > 0) {
          timeText = `${minutes} ph√∫t ${seconds} gi√¢y`;
        } else {
          timeText = `${seconds} gi√¢y`;
        }
        
        textElement.textContent = `${timeText} cho m·ªói c√¢u`;
        infoElement.style.display = 'block';
      } else if (timerPerQuestion && timeLimit === 0) {
        textElement.textContent = 'C·∫ßn ch·ªçn th·ªùi gian l√†m b√†i';
        infoElement.style.display = 'block';
      } else {
        infoElement.style.display = 'none';
      }
    }

    // Show create exam modal (Luy·ªán thi with settings)
    function showCreateExamModal() {
      if (!subjectId) {
        alert('Vui l√≤ng ch·ªçn m√¥n h·ªçc tr∆∞·ªõc');
        window.location.href = '/tracnghiemluyenthi/public/pages/subjects.html';
        return;
      }

      // Update max questions
      const maxQuestionsEl = document.getElementById('maxPracticeQuestions');
      if (maxQuestionsEl && currentSubject) {
        maxQuestionsEl.textContent = currentSubject.questionCount || 0;
      }

      // Set max attribute for input
      const questionCountInput = document.getElementById('practiceQuestionCount');
      if (questionCountInput && currentSubject) {
        questionCountInput.max = currentSubject.questionCount || 100;
        
        // Add event listeners to update time per question info
        questionCountInput.addEventListener('input', updateTimePerQuestionInfo);
        const timeLimitSelect = document.getElementById('practiceTimeLimit');
        if (timeLimitSelect) {
          timeLimitSelect.addEventListener('change', updateTimePerQuestionInfo);
        }
      }
      
      document.getElementById('createExamModal').classList.remove('hidden');
    }

    function closeCreateExamModal() {
      const modal = document.getElementById('createExamModal');
      const errorDiv = document.getElementById('createError');
      
      if (modal) modal.classList.add('hidden');
      if (errorDiv) errorDiv.classList.add('hidden');
    }

    // Create and start exam (Luy·ªán thi with custom settings)
    async function createAndStartExam() {
      const btn = document.getElementById('createExamBtn');
      const errorDiv = document.getElementById('createError');
      const errorMsg = document.getElementById('createErrorMessage');

      try {
        // Get settings from form
        const questionCount = parseInt(document.getElementById('practiceQuestionCount').value) || 5;
        const timeLimit = parseInt(document.getElementById('practiceTimeLimit').value) || 0;
        const timerPerQuestion = document.getElementById('timerPerQuestion').checked;
        const backgroundMusic = document.getElementById('backgroundMusic').checked;
        const soundEffects = document.getElementById('soundEffects').checked;

        // Validate question count
        const maxQuestions = currentSubject?.questionCount || 100;
        if (questionCount < 1 || questionCount > maxQuestions) {
          throw new Error(`S·ªë c√¢u h·ªèi ph·∫£i t·ª´ 1 ƒë·∫øn ${maxQuestions}`);
        }

        // Validate timer per question requirement
        if (timerPerQuestion && timeLimit === 0) {
          throw new Error('Vui l√≤ng ch·ªçn th·ªùi gian l√†m b√†i ƒë·ªÉ b·∫≠t ƒë·∫øm ng∆∞·ª£c m·ªói c√¢u');
        }

        // Calculate time per question (in seconds) if timer per question is enabled
        let timePerQuestion = 0;
        if (timerPerQuestion && timeLimit > 0) {
          // Convert minutes to seconds and divide by number of questions
          timePerQuestion = Math.floor((timeLimit * 60) / questionCount);
          console.log(`Time per question: ${timePerQuestion} seconds (${Math.floor(timePerQuestion / 60)}:${timePerQuestion % 60})`);
        }

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ƒêang chu·∫©n b·ªã...';
        if (errorDiv) errorDiv.classList.add('hidden');

        // Call API to create exam with settings
        const response = await API.post('/exams/start', {
          subjectId,
          questionCount,
          timeLimit,
          type: 'practice',
          settings: {
            timerPerQuestion,
            backgroundMusic,
            soundEffects,
            timePerQuestion // Add calculated time per question
          }
        });

        const exam = response.data?.exam || response.exam;
        if (!exam || !exam._id) {
          throw new Error('Kh√¥ng th·ªÉ t·∫°o b√†i luy·ªán thi. Vui l√≤ng th·ª≠ l·∫°i.');
        }

        // Build URL with settings as query params
        const params = new URLSearchParams({
          exam: exam._id,
          timerPerQuestion: timerPerQuestion ? '1' : '0',
          backgroundMusic: backgroundMusic ? '1' : '0',
          soundEffects: soundEffects ? '1' : '0',
          timePerQuestion: timePerQuestion.toString() // Pass time per question to quiz page
        });

        // Redirect to quiz page with settings
        window.location.href = `/tracnghiemluyenthi/public/pages/quiz.html?${params.toString()}`;
        
      } catch (error) {
        console.error('Error creating exam:', error);
        if (errorMsg) errorMsg.textContent = error.message || 'C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.';
        if (errorDiv) errorDiv.classList.remove('hidden');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-play"></i> B·∫Øt ƒë·∫ßu luy·ªán thi';
      }
    }

    // Question Bank Modal Functions
    let allQuestions = [];
    let filteredQuestionBank = [];

    async function showQuestionBankModal() {
      if (!subjectId) {
        alert('Vui l√≤ng ch·ªçn m√¥n h·ªçc tr∆∞·ªõc');
        return;
      }

      const modal = document.getElementById('questionBankModal');
      const subjectNameEl = document.getElementById('questionBankSubjectName');
      
      if (modal) modal.classList.remove('hidden');
      if (subjectNameEl) subjectNameEl.textContent = currentSubject?.name || 'ƒêang t·∫£i...';
      
      // Load questions
      await loadQuestionBank();
    }

    function closeQuestionBankModal() {
      const modal = document.getElementById('questionBankModal');
      if (modal) modal.classList.add('hidden');
    }

    async function loadQuestionBank() {
      try {
        // Use correct API endpoint with query parameter
        const response = await API.get(`/questions?subjectId=${subjectId}&limit=1000`);
        allQuestions = response.data?.questions || response.questions || [];
        
        console.log('Loaded questions:', allQuestions.length);
        
        // Reset filters with null checks
        const difficultyFilter = document.getElementById('difficultyFilter');
        const typeFilter = document.getElementById('typeFilter');
        
        if (difficultyFilter) difficultyFilter.value = 'all';
        if (typeFilter) typeFilter.value = 'all';
        
        filterQuestions();
      } catch (error) {
        console.error('Error loading question bank:', error);
        const listEl = document.getElementById('questionBankList');
        if (listEl) {
          listEl.innerHTML = `
            <div class="text-center py-8">
              <i class="fas fa-exclamation-circle text-4xl text-red-500 mb-3"></i>
              <p class="text-red-600">Kh√¥ng th·ªÉ t·∫£i ng√¢n h√†ng c√¢u h·ªèi</p>
              <p class="text-sm text-gray-500 mt-2">${error.message || 'Vui l√≤ng th·ª≠ l·∫°i sau'}</p>
            </div>
          `;
        }
      }
    }

    function filterQuestions() {
      const difficultyFilter = document.getElementById('difficultyFilter');
      const typeFilter = document.getElementById('typeFilter');
      
      const difficulty = difficultyFilter ? difficultyFilter.value : 'all';
      const type = typeFilter ? typeFilter.value : 'all';

      filteredQuestionBank = allQuestions.filter(q => {
        const matchDifficulty = difficulty === 'all' || q.difficulty === difficulty;
        const matchType = type === 'all' || q.type === type;
        return matchDifficulty && matchType;
      });

      const totalEl = document.getElementById('questionBankTotal');
      if (totalEl) totalEl.textContent = filteredQuestionBank.length;
      
      renderQuestionBank();
    }

    function renderQuestionBank() {
      const container = document.getElementById('questionBankList');

      if (filteredQuestionBank.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8">
            <i class="fas fa-search text-4xl text-gray-300 mb-3"></i>
            <p class="text-gray-600">Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi ph√π h·ª£p</p>
          </div>
        `;
        return;
      }

      container.innerHTML = filteredQuestionBank.map((question, index) => {
        const difficultyColors = {
          easy: 'bg-green-100 text-green-800',
          medium: 'bg-yellow-100 text-yellow-800',
          hard: 'bg-red-100 text-red-800'
        };
        const difficultyTexts = {
          easy: 'D·ªÖ',
          medium: 'Trung b√¨nh',
          hard: 'Kh√≥'
        };
        const typeTexts = {
          multiple_choice: 'Tr·∫Øc nghi·ªám',
          true_false: 'ƒê√∫ng/Sai'
        };

        const correctOption = question.options?.find(opt => opt.isCorrect);
        
        return `
          <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
            <div class="flex items-start justify-between mb-3">
              <div class="flex items-center gap-2">
                <span class="font-bold text-gray-700">C√¢u ${index + 1}</span>
                <span class="text-xs px-2 py-1 rounded-full ${difficultyColors[question.difficulty] || 'bg-gray-100 text-gray-800'}">
                  ${difficultyTexts[question.difficulty] || question.difficulty}
                </span>
                <span class="text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-800">
                  ${typeTexts[question.type] || question.type}
                </span>
              </div>
            </div>

            <div class="mb-3">
              <p class="text-gray-900 font-medium">${question.content}</p>
            </div>

            <div class="space-y-2 mb-3">
              ${question.options?.map((option, optIndex) => `
                <div class="flex items-start gap-2 p-2 rounded ${option.isCorrect ? 'bg-green-50 border border-green-200' : 'bg-gray-50'}">
                  <span class="flex-shrink-0 w-6 h-6 rounded-full ${option.isCorrect ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-600'} flex items-center justify-center text-sm font-semibold">
                    ${String.fromCharCode(65 + optIndex)}
                  </span>
                  <span class="text-gray-700 flex-1">${option.text}</span>
                  ${option.isCorrect ? '<i class="fas fa-check-circle text-green-600"></i>' : ''}
                </div>
              `).join('') || '<p class="text-gray-500 text-sm">Kh√¥ng c√≥ ƒë√°p √°n</p>'}
            </div>

            ${question.explanation ? `
              <div class="bg-blue-50 border border-blue-200 rounded p-3 text-sm">
                <p class="font-semibold text-blue-800 mb-1">
                  <i class="fas fa-lightbulb mr-1"></i>Gi·∫£i th√≠ch:
                </p>
                <p class="text-blue-700">${question.explanation}</p>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    // Start quiz - redirect to quiz page
    function startQuiz(quizId) {
      window.location.href = `/tracnghiemluyenthi/public/pages/quiz.html?exam=${quizId}`;
    }

    // Get difficulty text based on database values
    function getDifficultyText(difficulty) {
      const texts = {
        easy: 'D·ªÖ',
        medium: 'Trung b√¨nh',
        hard: 'Kh√≥'
      };
      return texts[difficulty] || difficulty || 'Ch∆∞a x√°c ƒë·ªãnh';
    }

    // Initialize
    loadSubjectInfo();
    loadExams();
  </script>
</body>
</html>
