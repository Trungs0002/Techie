<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>L√†m b√†i thi - Techie</title>
  
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Custom CSS -->
  <link rel="stylesheet" href="/tracnghiemluyenthi/public/assets/css/main.css">
  <link rel="stylesheet" href="/tracnghiemluyenthi/public/assets/css/components.css">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    /* Prevent accidental navigation */
    body {
      overscroll-behavior: none;
    }

    /* Question palette grid */
    .question-palette {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(48px, 1fr));
      gap: 0.5rem;
    }

    /* Question number button */
    .question-btn {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 0.5rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .question-btn:hover {
      transform: scale(1.05);
    }

    /* Question states */
    .question-btn.answered {
      background-color: #10B981;
      color: white;
    }

    .question-btn.current {
      background-color: #3B82F6;
      color: white;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
    }

    .question-btn.marked {
      background-color: #F59E0B;
      color: white;
    }

    .question-btn.unanswered {
      background-color: #E5E7EB;
      color: #374151;
    }

    /* Answer feedback states */
    .answer-correct {
      background-color: #D1FAE5 !important;
      border-color: #10B981 !important;
      animation: correctPulse 0.5s ease;
    }

    .answer-wrong {
      background-color: #FEE2E2 !important;
      border-color: #EF4444 !important;
      animation: wrongShake 0.5s ease;
    }

    .answer-disabled {
      pointer-events: none;
      opacity: 0.7;
    }

    @keyframes correctPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.02); }
      100% { transform: scale(1); }
    }

    @keyframes wrongShake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    /* Timer warning animation */
    @keyframes pulse-red {
      0%, 100% { color: #EF4444; }
      50% { color: #DC2626; }
    }

    .timer-warning {
      animation: pulse-red 1s infinite;
    }

    /* Full screen mode */
    .fullscreen-mode {
      position: fixed;
      inset: 0;
      z-index: 9999;
      background: white;
      overflow-y: auto;
    }
  </style>
</head>
<body class="bg-gray-50">
  <!-- Quiz Header (Sticky) -->
  <header class="bg-white shadow-sm sticky top-0 z-40">
    <div class="container mx-auto px-4">
      <div class="flex items-center justify-between h-16">
        <!-- Exam Info -->
        <div class="flex items-center gap-4">
          <i class="fas fa-graduation-cap text-2xl text-blue-600"></i>
          <div class="hidden md:block">
            <h1 class="font-semibold text-gray-900" id="examTitle">ƒêang t·∫£i...</h1>
            <p class="text-sm text-gray-600" id="examSubject">M√¥n h·ªçc</p>
          </div>
        </div>

        <!-- Timer & Actions -->
        <div class="flex items-center gap-4">
          <!-- Timer -->
          <div class="flex items-center gap-2 px-4 py-2 bg-blue-50 rounded-lg">
            <i class="fas fa-clock text-blue-600"></i>
            <span class="font-mono font-bold text-lg" id="timer">00:00</span>
          </div>

          <!-- Actions -->
          <div class="flex items-center gap-2">
            <!-- Background Music Toggle (if enabled) -->
            <button id="musicToggleBtn" class="hidden btn btn-secondary btn-sm" title="Nh·∫°c n·ªÅn">
              <i class="fas fa-music"></i>
            </button>
            
            <button id="fullscreenBtn" class="btn btn-secondary btn-sm" title="To√†n m√†n h√¨nh">
              <i class="fas fa-expand"></i>
            </button>
            <button id="submitBtn" class="btn btn-danger btn-sm">
              <i class="fas fa-paper-plane"></i>
              <span class="hidden md:inline">N·ªôp b√†i</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Mobile Exam Info -->
      <div class="md:hidden pb-3">
        <h2 class="font-semibold text-gray-900" id="examTitleMobile">ƒêang t·∫£i...</h2>
        <p class="text-sm text-gray-600" id="examSubjectMobile">M√¥n h·ªçc</p>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container mx-auto px-4 py-6">
    <div class="grid lg:grid-cols-4 gap-6">
      <!-- Questions Panel (Main Content) -->
      <div class="lg:col-span-3 space-y-6">
        <!-- Question Card -->
        <div class="card bg-white">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-gray-900">
              C√¢u <span id="currentQuestionNumber">1</span> / <span id="totalQuestions">0</span>
            </h2>
            <div class="flex items-center gap-3">
              <!-- Per Question Timer (in question card) -->
              <div id="perQuestionTimerCard" class="hidden flex items-center gap-2 px-3 py-1.5 bg-purple-50 rounded-lg border-2 border-purple-200">
                <i class="fas fa-stopwatch text-purple-600"></i>
                <span class="font-mono font-bold text-base" id="perQuestionTimerCard">00:00</span>
              </div>
              
              <button id="markBtn" class="btn btn-secondary btn-sm">
                <i class="fas fa-flag"></i>
                <span id="markText">ƒê√°nh d·∫•u</span>
              </button>
            </div>
          </div>

          <!-- Question Content -->
          <div id="questionContent" class="mb-6">
            <div class="animate-pulse">
              <div class="h-4 bg-gray-300 rounded w-3/4 mb-2"></div>
              <div class="h-4 bg-gray-300 rounded w-full"></div>
            </div>
          </div>

          <!-- Question Image (if exists) -->
          <div id="questionImage" class="hidden mb-6">
            <img src="" alt="Question image" class="max-w-full rounded-lg shadow-sm">
          </div>

          <!-- Answer Options -->
          <div id="answerOptions" class="space-y-3">
            <!-- Will be populated by JavaScript -->
          </div>

          <!-- Action Buttons -->
          <div class="flex items-center justify-center gap-3 mt-6 pt-6 border-t border-gray-200">
            <button id="clearBtn" class="btn btn-secondary">
              <i class="fas fa-eraser"></i>
              X√≥a ƒë√°p √°n
            </button>
            <button id="submitAnswerBtn" class="btn btn-primary hidden">
              <i class="fas fa-check"></i>
              Submit c√¢u tr·∫£ l·ªùi
            </button>
          </div>
        </div>

        <!-- Instructions (Collapsible) -->
        <div class="card bg-blue-50 border border-blue-200">
          <button class="flex items-center justify-between w-full text-left" onclick="toggleInstructions()">
            <div class="flex items-center gap-2">
              <i class="fas fa-info-circle text-blue-600"></i>
              <span class="font-semibold text-blue-900">H∆∞·ªõng d·∫´n l√†m b√†i</span>
            </div>
            <i class="fas fa-chevron-down text-blue-600" id="instructionsIcon"></i>
          </button>
          <div id="instructionsContent" class="hidden mt-3 text-sm text-blue-800 space-y-1">
            <p>‚Ä¢ Ch·ªçn 1 ƒë√°p √°n cho m·ªói c√¢u h·ªèi</p>
            <p>‚Ä¢ C√≥ th·ªÉ ƒë√°nh d·∫•u c√¢u h·ªèi ƒë·ªÉ xem l·∫°i sau</p>
            <p>‚Ä¢ B√†i thi t·ª± ƒë·ªông l∆∞u sau m·ªói 30 gi√¢y</p>
            <p>‚Ä¢ B√†i thi s·∫Ω t·ª± ƒë·ªông n·ªôp khi h·∫øt gi·ªù</p>
            <p>‚Ä¢ Kh√¥ng tho√°t kh·ªèi trang trong khi l√†m b√†i</p>
          </div>
        </div>
      </div>

      <!-- Question Palette Sidebar -->
      <div class="lg:col-span-1">
        <div class="card bg-white sticky top-24">
          <h3 class="font-semibold text-gray-900 mb-4">Danh s√°ch c√¢u h·ªèi</h3>

          <!-- Legend -->
          <div class="grid grid-cols-2 gap-2 mb-4 text-xs">
            <div class="flex items-center gap-2">
              <div class="w-4 h-4 bg-green-500 rounded"></div>
              <span>ƒê√£ tr·∫£ l·ªùi</span>
            </div>
            <div class="flex items-center gap-2">
              <div class="w-4 h-4 bg-gray-300 rounded"></div>
              <span>Ch∆∞a tr·∫£ l·ªùi</span>
            </div>
            <div class="flex items-center gap-2">
              <div class="w-4 h-4 bg-blue-500 rounded"></div>
              <span>ƒêang l√†m</span>
            </div>
            <div class="flex items-center gap-2">
              <div class="w-4 h-4 bg-yellow-500 rounded"></div>
              <span>ƒê√°nh d·∫•u</span>
            </div>
          </div>

          <!-- Question Grid -->
          <div id="questionPalette" class="question-palette">
            <!-- Will be populated by JavaScript -->
          </div>

          <!-- Summary -->
          <div class="mt-4 pt-4 border-t border-gray-200 space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="text-gray-600">ƒê√£ tr·∫£ l·ªùi:</span>
              <span class="font-semibold text-green-600" id="answeredCount">0</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Ch∆∞a tr·∫£ l·ªùi:</span>
              <span class="font-semibold text-gray-600" id="unansweredCount">0</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">ƒê√°nh d·∫•u:</span>
              <span class="font-semibold text-yellow-600" id="markedCount">0</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Submit Confirmation Modal -->
  <div id="submitModal" class="hidden modal-overlay">
    <div class="modal-content max-w-lg">
      <div class="modal-header">
        <h2 class="modal-title">X√°c nh·∫≠n n·ªôp b√†i</h2>
      </div>
      <div class="modal-body">
        <div class="space-y-4">
          <p class="text-gray-700">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i kh√¥ng?</p>
          
          <div class="bg-gray-50 rounded-lg p-4 space-y-2">
            <div class="flex justify-between">
              <span class="text-gray-600">T·ªïng s·ªë c√¢u:</span>
              <span class="font-semibold" id="modalTotalQuestions">0</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">ƒê√£ tr·∫£ l·ªùi:</span>
              <span class="font-semibold text-green-600" id="modalAnswered">0</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Ch∆∞a tr·∫£ l·ªùi:</span>
              <span class="font-semibold text-red-600" id="modalUnanswered">0</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Th·ªùi gian c√≤n l·∫°i:</span>
              <span class="font-semibold text-blue-600" id="modalTimeLeft">00:00</span>
            </div>
          </div>

          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <p class="text-sm">Sau khi n·ªôp b√†i, b·∫°n kh√¥ng th·ªÉ ch·ªânh s·ª≠a c√¢u tr·∫£ l·ªùi.</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeSubmitModal()">
          <i class="fas fa-times"></i>
          H·ªßy
        </button>
        <button class="btn btn-primary" id="confirmSubmitBtn">
          <i class="fas fa-check"></i>
          X√°c nh·∫≠n n·ªôp b√†i
        </button>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
      <p class="text-gray-700 font-medium">ƒêang x·ª≠ l√Ω...</p>
    </div>
  </div>

  <!-- Audio Elements -->
  <audio id="backgroundMusic" loop preload="auto" src="http://localhost:5000/assets/audio/background.mp3"></audio>
  <audio id="correctSound" preload="auto" src="http://localhost:5000/assets/audio/correct.mp3"></audio>
  <audio id="wrongSound" preload="auto" src="http://localhost:5000/assets/audio/wrong.mp3"></audio>
  <audio id="timeUpSound" preload="auto" src="http://localhost:5000/assets/audio/time-up.mp3"></audio>

  <!-- Scripts -->
  <script src="/tracnghiemluyenthi/public/assets/js/config.js"></script>
  <script src="/tracnghiemluyenthi/public/assets/js/utils.js"></script>
  <script src="/tracnghiemluyenthi/public/assets/js/api.js"></script>
  <script src="/tracnghiemluyenthi/public/assets/js/auth.js"></script>
  
  <script>
    // Require authentication
    if (!Auth.requireAuth()) {
      // Will redirect to login
    }

    // Get exam ID and settings from URL
    const urlParams = new URLSearchParams(window.location.search);
    const examId = urlParams.get('exam');
    const timerPerQuestionEnabled = urlParams.get('timerPerQuestion') === '1';
    const backgroundMusicEnabled = urlParams.get('backgroundMusic') === '1';
    const soundEffectsEnabled = urlParams.get('soundEffects') === '1';
    const timePerQuestion = parseInt(urlParams.get('timePerQuestion')) || 0; // in seconds

    console.log('Quiz settings:', {
      timerPerQuestionEnabled,
      backgroundMusicEnabled,
      soundEffectsEnabled,
      timePerQuestion
    });

    if (!examId) {
      Utils.showToast('Kh√¥ng t√¨m th·∫•y ƒë·ªÅ thi', 'error');
      setTimeout(() => window.location.href = '/tracnghiemluyenthi/public/pages/exams.html', 2000);
    }

    // Quiz State
    let quizData = {
      exam: null,
      questions: [],
      currentQuestionIndex: 0,
      answers: {}, // questionId: answerIndex
      markedQuestions: new Set(),
      startTime: null,
      timeLeft: 0, // in seconds
      duration: 0, // in minutes
      perQuestionTimeLeft: timePerQuestion, // seconds for current question
      questionTimers: {}, // Track time left for each question {questionIndex: timeLeft}
      tempSelectedAnswer: null, // Temporary selected answer before submit
      isShowingFeedback: false, // Flag to prevent actions during feedback
      submittedQuestions: new Set() // Track which questions have been submitted
    };

    let timerInterval = null;
    let autoSaveInterval = null;
    let perQuestionTimerInterval = null;
    let backgroundMusic = null;
    let isMusicPlaying = false;

    // Load exam and questions
    async function loadExam() {
      try {
        Utils.showLoading('ƒêang t·∫£i ƒë·ªÅ thi...');

        // Check for saved progress in localStorage
        const savedProgress = localStorage.getItem(`quiz_${examId}`);
        
        // Call quiz/start API with examId
        const response = await API.post('/quiz/start', { examId });
        
        // Response structure: {success: true, data: {exam, questions, startTime}}
        const data = response.data || response;
        quizData.exam = data.exam;
        quizData.questions = data.questions || [];
        // Get time limit from exam settings (in minutes)
        quizData.duration = data.exam.settings?.timeLimit || 30; // Default 30 minutes
        quizData.startTime = new Date(data.startTime || Date.now());
        
        console.log('Exam loaded:', {
          title: data.exam.title,
          timeLimit: quizData.duration,
          questionCount: quizData.questions.length,
          settings: data.exam.settings
        });
        
        // Restore saved progress if exists
        if (savedProgress) {
          try {
            const saved = JSON.parse(savedProgress);
            if (saved.answers) quizData.answers = saved.answers;
            if (saved.markedQuestions) quizData.markedQuestions = new Set(saved.markedQuestions);
            if (saved.currentQuestion !== undefined) quizData.currentQuestionIndex = saved.currentQuestion;
            if (saved.questionTimers) quizData.questionTimers = saved.questionTimers; // Restore per-question timers
            // Calculate remaining time based on saved time
            if (saved.savedAt && saved.startTime) {
              const elapsedMs = saved.savedAt - saved.startTime;
              const elapsedSec = Math.floor(elapsedMs / 1000);
              quizData.timeLeft = Math.max(0, (quizData.duration * 60) - elapsedSec);
            } else {
              quizData.timeLeft = quizData.duration * 60;
            }
            console.log('Restored progress from localStorage');
          } catch (e) {
            console.error('Error restoring saved progress:', e);
            quizData.timeLeft = quizData.duration * 60;
          }
        } else {
          quizData.timeLeft = quizData.duration * 60; // Convert to seconds
        }

        // Update UI
        document.getElementById('examTitle').textContent = quizData.exam.title || 'ƒê·ªÅ thi';
        document.getElementById('examTitleMobile').textContent = quizData.exam.title || 'ƒê·ªÅ thi';
        document.getElementById('examSubject').textContent = data.exam.subject?.name || 'M√¥n h·ªçc';
        document.getElementById('examSubjectMobile').textContent = data.exam.subject?.name || 'M√¥n h·ªçc';
        document.getElementById('totalQuestions').textContent = quizData.questions.length;

        // Initialize
        renderQuestionPalette();
        renderCurrentQuestion();
        startTimer();
        startAutoSave();
        
        // Initialize background music if enabled
        if (backgroundMusicEnabled) {
          initializeBackgroundMusic();
        }
        
        // Start per-question timer if enabled
        if (timerPerQuestionEnabled && timePerQuestion > 0) {
          const timerCard = document.getElementById('perQuestionTimerCard');
          if (timerCard) {
            timerCard.classList.remove('hidden');
          }
          startPerQuestionTimer();
        }

        Utils.hideLoading();

        // Prevent page unload
        window.addEventListener('beforeunload', handleBeforeUnload);

      } catch (error) {
        console.error('Error loading exam:', error);
        Utils.hideLoading();
        Utils.showToast(error.message || 'Kh√¥ng th·ªÉ t·∫£i ƒë·ªÅ thi. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
        
        // Redirect back to exams page after 2 seconds
        setTimeout(() => {
          window.location.href = '/tracnghiemluyenthi/public/pages/exams.html';
        }, 2000);
      }
    }

    // Render question palette
    function renderQuestionPalette() {
      const palette = document.getElementById('questionPalette');
      
      palette.innerHTML = quizData.questions.map((q, index) => {
        const isAnswered = quizData.answers[q._id || index] !== undefined;
        const isCurrent = index === quizData.currentQuestionIndex;
        const isMarked = quizData.markedQuestions.has(index);
        
        let className = 'question-btn ';
        if (isCurrent) className += 'current';
        else if (isMarked) className += 'marked';
        else if (isAnswered) className += 'answered';
        else className += 'unanswered';
        
        return `
          <button class="${className}" onclick="goToQuestion(${index})" title="C√¢u ${index + 1}">
            ${index + 1}
          </button>
        `;
      }).join('');
      
      updateSummary();
    }

    // Render current question
    function renderCurrentQuestion() {
      const question = quizData.questions[quizData.currentQuestionIndex];
      if (!question) return;

      const questionId = question._id || quizData.currentQuestionIndex;
      
      // Update question number
      document.getElementById('currentQuestionNumber').textContent = quizData.currentQuestionIndex + 1;
      
      // Update question content
      document.getElementById('questionContent').innerHTML = `
        <div class="text-lg text-gray-900 leading-relaxed">${question.question || question.content}</div>
      `;
      
      // Show image if exists
      if (question.image) {
        document.getElementById('questionImage').classList.remove('hidden');
        document.getElementById('questionImage').querySelector('img').src = question.image;
      } else {
        document.getElementById('questionImage').classList.add('hidden');
      }
      
      // Render answer options
      const selectedAnswer = quizData.answers[questionId];
      const optionsContainer = document.getElementById('answerOptions');
      const isSubmitted = quizData.submittedQuestions.has(quizData.currentQuestionIndex);
      
      console.log('Rendering question:', {
        questionId,
        selectedAnswer,
        options: question.options,
        isSubmitted
      });
      
      optionsContainer.innerHTML = (question.options || []).map((option, index) => {
        // Handle both string and object format
        const optionText = typeof option === 'string' ? option : (option?.text || option);
        const isSelected = selectedAnswer === optionText;
        const letter = String.fromCharCode(65 + index); // A, B, C, D
        
        return `
          <label class="flex items-start gap-3 p-4 border-2 rounded-lg transition-all ${
            isSubmitted 
              ? 'cursor-not-allowed opacity-70 ' + (isSelected ? 'border-blue-500 bg-blue-50' : 'border-gray-200')
              : 'cursor-pointer ' + (isSelected ? 'border-blue-500 bg-blue-50 shadow-md' : 'border-gray-200 hover:border-blue-300 hover:bg-gray-50')
          }">
            <input 
              type="radio" 
              name="answer" 
              value="${index}"
              ${isSelected ? 'checked' : ''}
              ${isSubmitted ? 'disabled' : ''}
              onchange="selectAnswer(${index})"
              class="mt-1 w-5 h-5 text-blue-600 ${isSubmitted ? 'cursor-not-allowed' : 'cursor-pointer'}"
            >
            <div class="flex-1">
              <span class="font-semibold text-gray-700 mr-2">${letter}.</span>
              <span class="text-gray-900">${optionText}</span>
              ${isSelected ? '<i class="fas fa-check-circle text-blue-600 ml-2"></i>' : ''}
              ${isSubmitted && isSelected ? '<i class="fas fa-lock text-gray-500 ml-2"></i>' : ''}
            </div>
          </label>
        `;
      }).join('');
      
      // Update mark button
      const isMarked = quizData.markedQuestions.has(quizData.currentQuestionIndex);
      document.getElementById('markText').textContent = isMarked ? 'B·ªè ƒë√°nh d·∫•u' : 'ƒê√°nh d·∫•u';
      
      // Update submit answer button and clear button visibility
      const submitBtn = document.getElementById('submitAnswerBtn');
      const clearBtn = document.getElementById('clearBtn');
      const hasTempSelection = quizData.tempSelectedAnswer !== null;
      
      if (submitBtn) {
        if (isSubmitted || !hasTempSelection) {
          submitBtn.classList.add('hidden');
        } else {
          submitBtn.classList.remove('hidden');
        }
      }
      
      // Disable clear button if question is already submitted
      if (clearBtn) {
        clearBtn.disabled = isSubmitted;
        if (isSubmitted) {
          clearBtn.classList.add('opacity-50', 'cursor-not-allowed');
        } else {
          clearBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
      }
      
      // Update palette
      renderQuestionPalette();
    }

    // Select answer (temporary selection, not saved until submit)
    function selectAnswer(answerIndex) {
      // Prevent selection during feedback
      if (quizData.isShowingFeedback) return;
      
      // Check if question already submitted
      if (quizData.submittedQuestions.has(quizData.currentQuestionIndex)) return;
      
      const question = quizData.questions[quizData.currentQuestionIndex];
      const questionId = question._id || quizData.currentQuestionIndex;
      
      // Store temporary selection (not saved to answers yet)
      quizData.tempSelectedAnswer = answerIndex;
      
      console.log('Answer selected (temp):', {
        questionIndex: quizData.currentQuestionIndex,
        questionId,
        answerIndex
      });
      
      // Update CSS for all option labels
      const optionsContainer = document.getElementById('answerOptions');
      const labels = optionsContainer.querySelectorAll('label');
      
      labels.forEach((label, index) => {
        const isSelected = index === answerIndex;
        
        // Remove all selection classes first
        label.classList.remove('border-blue-500', 'bg-blue-50', 'shadow-md', 'border-gray-200');
        
        // Add appropriate classes
        if (isSelected) {
          label.classList.add('border-blue-500', 'bg-blue-50', 'shadow-md');
          
          // Add check icon if not exists
          const checkIcon = label.querySelector('.fa-check-circle');
          if (!checkIcon) {
            const textSpan = label.querySelector('div');
            textSpan.innerHTML += ' <i class="fas fa-check-circle text-blue-600 ml-2"></i>';
          }
        } else {
          label.classList.add('border-gray-200');
          
          // Remove check icon if exists
          const checkIcon = label.querySelector('.fa-check-circle');
          if (checkIcon) {
            checkIcon.remove();
          }
        }
      });
      
      // Show submit button when answer is selected
      const submitBtn = document.getElementById('submitAnswerBtn');
      if (submitBtn) {
        submitBtn.classList.remove('hidden');
      }
    }

    // Submit answer for current question
    async function submitAnswerForCurrentQuestion() {
      // Prevent double submit
      if (quizData.tempSelectedAnswer === null) return;
      if (quizData.isShowingFeedback) return;
      if (quizData.submittedQuestions.has(quizData.currentQuestionIndex)) return;
      
      const question = quizData.questions[quizData.currentQuestionIndex];
      const questionId = question._id || quizData.currentQuestionIndex;
      
      // Get selected option
      const selectedIndex = quizData.tempSelectedAnswer;
      const option = question.options[selectedIndex];
      const answerText = typeof option === 'string' ? option : (option?.text || option);
      
      // Save answer to answers object
      quizData.answers[questionId] = answerText;
      
      // Mark this question as submitted
      quizData.submittedQuestions.add(quizData.currentQuestionIndex);
      
      try {
        // Call API to check answer
        const response = await API.post('/quiz/check-answer', {
          questionId: questionId,
          selectedAnswer: answerText
        });
        
        const result = response.data || response;
        const isCorrect = result.isCorrect;
        const correctOptionsData = result.options; // Full options with isCorrect flags
        
        console.log('Answer checked:', {
          questionIndex: quizData.currentQuestionIndex,
          questionId,
          selectedIndex,
          answerText,
          isCorrect,
          correctAnswer: result.correctAnswer,
          optionsData: correctOptionsData,
          soundEffectsEnabled: soundEffectsEnabled
        });
        
        // Play sound effect (always play for testing, check settings later)
        console.log(`Attempting to play sound: ${isCorrect ? 'correct' : 'wrong'}, soundEffectsEnabled: ${soundEffectsEnabled}`);
        playSound(isCorrect ? 'correct' : 'wrong');
        
        // Show visual feedback with correct answer info
        showAnswerFeedback(isCorrect, selectedIndex, correctOptionsData);
        
        // Save progress
        saveProgress();
      } catch (error) {
        console.error('Error checking answer:', error);
        Utils.showToast('L·ªói khi ki·ªÉm tra ƒë√°p √°n', 'error');
        
        // Rollback
        quizData.submittedQuestions.delete(quizData.currentQuestionIndex);
        delete quizData.answers[questionId];
      }
    }

    // Show answer feedback for 3 seconds then auto-next
    function showAnswerFeedback(isCorrect, selectedIndex, correctOptionsData) {
      quizData.isShowingFeedback = true;
      
      const question = quizData.questions[quizData.currentQuestionIndex];
      const optionsContainer = document.getElementById('answerOptions');
      const labels = optionsContainer.querySelectorAll('label');
      
      // Disable all options during feedback
      optionsContainer.classList.add('answer-disabled');
      
      // Highlight correct answer (green) and wrong answer if selected (red)
      labels.forEach((label, index) => {
        const option = question.options[index];
        const optionText = typeof option === 'string' ? option : (option?.text || option);
        
        // Clear any existing feedback classes first
        label.classList.remove('answer-correct', 'answer-wrong');
        
        // Find if this option is correct using data from API
        let isCorrectOption = false;
        if (correctOptionsData && Array.isArray(correctOptionsData)) {
          const matchingOption = correctOptionsData.find(opt => opt.text === optionText);
          isCorrectOption = matchingOption && matchingOption.isCorrect === true;
        }
        
        console.log(`Option ${index}:`, {
          optionText,
          isCorrectOption,
          isSelected: index === selectedIndex,
          userAnswerCorrect: isCorrect
        });
        
        // Priority: Correct answer always gets green, even if it was selected
        if (isCorrectOption) {
          // Always highlight correct answer in green
          label.classList.add('answer-correct');
          console.log(`‚úÖ Added green to option ${index} (correct answer)`);
        } else if (index === selectedIndex && !isCorrect) {
          // Only add red if: selected BUT not correct
          label.classList.add('answer-wrong');
          console.log(`‚ùå Added red to option ${index} (wrong answer)`);
        }
      });
      
      console.log('Showing feedback:', {
        isCorrect,
        selectedIndex,
        questionOptions: question.options
      });
      
      // Hide submit button
      const submitBtn = document.getElementById('submitAnswerBtn');
      if (submitBtn) {
        submitBtn.classList.add('hidden');
      }
      
      // Auto-next after 3 seconds
      setTimeout(() => {
        // Reset feedback state
        quizData.isShowingFeedback = false;
        quizData.tempSelectedAnswer = null;
        
        // Remove feedback classes
        labels.forEach(label => {
          label.classList.remove('answer-correct', 'answer-wrong');
        });
        optionsContainer.classList.remove('answer-disabled');
        
        // Move to next question or finish exam
        if (quizData.currentQuestionIndex < quizData.questions.length - 1) {
          goToQuestion(quizData.currentQuestionIndex + 1);
        } else {
          // Last question - show completion message
          showToast('ƒê√£ ho√†n th√†nh t·∫•t c·∫£ c√°c c√¢u h·ªèi!', 'success');
          // Auto-submit exam after a brief pause
          setTimeout(() => {
            submitQuiz(false);
          }, 1000);
        }
      }, 1500);
    }

    // Play sound effect
    function playSound(type) {
      try {
        let audio;
        let elementId;
        
        if (type === 'correct') {
          elementId = 'correctSound';
          audio = document.getElementById(elementId);
        } else if (type === 'wrong') {
          elementId = 'wrongSound';
          audio = document.getElementById(elementId);
        } else if (type === 'timeUpSound') {
          elementId = 'timeUpSound';
          audio = document.getElementById(elementId);
        }
        
        console.log(`playSound called with type: ${type}, elementId: ${elementId}, audio element:`, audio);
        
        if (audio) {
          audio.volume = 0.5;
          audio.currentTime = 0; // Reset to start
          console.log(`About to play audio, src:`, audio.src);
          audio.play()
            .then(() => console.log(`‚úÖ Playing ${type} sound successfully`))
            .catch(err => console.error(`‚ùå Sound play error for ${type}:`, err));
        } else {
          console.error(`‚ùå Audio element not found for type: ${type}, elementId: ${elementId}`);
        }
      } catch (error) {
        console.error('‚ùå Sound error:', error);
      }
    }

    // Go to specific question
    function goToQuestion(index) {
      // Prevent navigation during feedback
      if (quizData.isShowingFeedback) return;
      
      // Reset temporary selection when changing question
      quizData.tempSelectedAnswer = null;
      
      quizData.currentQuestionIndex = index;
      renderCurrentQuestion();
      
      // Restart per-question timer if enabled
      if (timerPerQuestionEnabled && timePerQuestion > 0) {
        startPerQuestionTimer();
      }
      
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Submit answer button
    document.getElementById('submitAnswerBtn').addEventListener('click', () => {
      submitAnswerForCurrentQuestion();
    });

    // Clear answer
    document.getElementById('clearBtn').addEventListener('click', () => {
      // Prevent clearing submitted questions
      if (quizData.submittedQuestions.has(quizData.currentQuestionIndex)) {
        Utils.showToast('Kh√¥ng th·ªÉ x√≥a c√¢u tr·∫£ l·ªùi ƒë√£ submit!', 'warning');
        return;
      }
      
      const questionId = quizData.questions[quizData.currentQuestionIndex]._id || quizData.currentQuestionIndex;
      delete quizData.answers[questionId];
      quizData.tempSelectedAnswer = null;
      
      // Hide submit button when clearing
      const submitBtn = document.getElementById('submitAnswerBtn');
      if (submitBtn) {
        submitBtn.classList.add('hidden');
      }
      
      renderCurrentQuestion();
    });

    // Mark question
    document.getElementById('markBtn').addEventListener('click', () => {
      if (quizData.markedQuestions.has(quizData.currentQuestionIndex)) {
        quizData.markedQuestions.delete(quizData.currentQuestionIndex);
      } else {
        quizData.markedQuestions.add(quizData.currentQuestionIndex);
      }
      renderCurrentQuestion();
    });

    // Update summary
    function updateSummary() {
      const answered = Object.keys(quizData.answers).length;
      const total = quizData.questions.length;
      const unanswered = total - answered;
      const marked = quizData.markedQuestions.size;
      
      document.getElementById('answeredCount').textContent = answered;
      document.getElementById('unansweredCount').textContent = unanswered;
      document.getElementById('markedCount').textContent = marked;
    }

    // Timer
    function startTimer() {
      updateTimerDisplay();
      
      timerInterval = setInterval(() => {
        quizData.timeLeft--;
        updateTimerDisplay();
        
        // Warning at 5 minutes
        if (quizData.timeLeft === 300) {
          Utils.showToast('C√≤n 5 ph√∫t n·ªØa h·∫øt gi·ªù!', 'warning');
          document.getElementById('timer').classList.add('timer-warning');
        }
        
        // Auto submit at 0
        if (quizData.timeLeft <= 0) {
          clearInterval(timerInterval);
          if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);
          Utils.showToast('H·∫øt gi·ªù! ƒêang t·ª± ƒë·ªông n·ªôp b√†i...', 'warning');
          setTimeout(() => submitQuiz(true), 1000);
        }
      }, 1000);
    }

    function updateTimerDisplay() {
      const minutes = Math.floor(quizData.timeLeft / 60);
      const seconds = quizData.timeLeft % 60;
      const display = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      document.getElementById('timer').textContent = display;
    }

    // Per-question timer
    function startPerQuestionTimer() {
      // Clear existing interval if any
      if (perQuestionTimerInterval) {
        clearInterval(perQuestionTimerInterval);
      }
      
      const currentIndex = quizData.currentQuestionIndex;
      
      // Initialize timer for this question if not exists, or restore saved time
      if (quizData.questionTimers[currentIndex] === undefined) {
        quizData.questionTimers[currentIndex] = timePerQuestion;
      }
      
      // Set current time left from saved state
      quizData.perQuestionTimeLeft = quizData.questionTimers[currentIndex];
      
      // If time already ran out for this question, don't start timer
      if (quizData.perQuestionTimeLeft <= 0) {
        updatePerQuestionTimerDisplay();
        return;
      }
      
      updatePerQuestionTimerDisplay();
      
      perQuestionTimerInterval = setInterval(() => {
        quizData.perQuestionTimeLeft--;
        quizData.questionTimers[currentIndex] = quizData.perQuestionTimeLeft; // Save current state
        updatePerQuestionTimerDisplay();
        
        // Warning at 10 seconds
        if (quizData.perQuestionTimeLeft === 10) {
          const timerDisplay = document.getElementById('perQuestionTimerCard');
          if (timerDisplay) {
            timerDisplay.classList.add('timer-warning');
          }
          if (soundEffectsEnabled) {
            playSound('timeUpSound');
          }
        }
        
        // Auto submit and move to next question when time is up
        if (quizData.perQuestionTimeLeft <= 0) {
          clearInterval(perQuestionTimerInterval);
          quizData.questionTimers[currentIndex] = 0; // Mark as expired
          Utils.showToast('H·∫øt th·ªùi gian cho c√¢u n√†y!', 'warning');
          
          // If user has selected an answer but not submitted, auto-submit it
          if (quizData.tempSelectedAnswer !== null && !quizData.submittedQuestions.has(currentIndex)) {
            submitAnswerForCurrentQuestion();
          } else {
            // No answer selected or already submitted, just move to next
            setTimeout(() => {
              if (quizData.currentQuestionIndex < quizData.questions.length - 1) {
                goToQuestion(quizData.currentQuestionIndex + 1);
              } else {
                showSubmitModal();
              }
            }, 500);
          }
        }
      }, 1000);
    }

    function updatePerQuestionTimerDisplay() {
      const minutes = Math.floor(quizData.perQuestionTimeLeft / 60);
      const seconds = quizData.perQuestionTimeLeft % 60;
      const display = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      const timerElement = document.getElementById('perQuestionTimerCard');
      
      if (timerElement) {
        timerElement.textContent = display;
        
        // Remove warning class if time increases (question changed)
        if (quizData.perQuestionTimeLeft > 10) {
          timerElement.classList.remove('timer-warning');
        }
      }
    }

    // Background music functions
    function initializeBackgroundMusic() {
      backgroundMusic = document.getElementById('backgroundMusic');
      const musicToggleBtn = document.getElementById('musicToggleBtn');
      
      if (musicToggleBtn) {
        musicToggleBtn.classList.remove('hidden');
        
        // Start music automatically
        backgroundMusic.volume = 0.6; // Set to 60% volume
        backgroundMusic.play().then(() => {
          isMusicPlaying = true;
          musicToggleBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
          console.log('Background music started');
        }).catch(err => {
          console.log('Could not auto-play music (user interaction required):', err);
          isMusicPlaying = false;
          musicToggleBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
        });
        
        // Toggle music on button click
        musicToggleBtn.addEventListener('click', toggleBackgroundMusic);
      }
    }

    function toggleBackgroundMusic() {
      const musicToggleBtn = document.getElementById('musicToggleBtn');
      
      if (isMusicPlaying) {
        backgroundMusic.pause();
        isMusicPlaying = false;
        if (musicToggleBtn) {
          musicToggleBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
        }
      } else {
        backgroundMusic.play().then(() => {
          isMusicPlaying = true;
          if (musicToggleBtn) {
            musicToggleBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
          }
        }).catch(err => {
          console.error('Error playing music:', err);
        });
      }
    }

    // Auto save
    function startAutoSave() {
      // Save to localStorage only (backend doesn't support auto-save)
      autoSaveInterval = setInterval(() => {
        saveProgress();
      }, CONFIG.QUIZ_SETTINGS.AUTO_SAVE_INTERVAL);
    }

    function saveProgress() {
      try {
        // Save progress to localStorage for recovery
        localStorage.setItem(`quiz_${examId}`, JSON.stringify({
          answers: quizData.answers,
          markedQuestions: Array.from(quizData.markedQuestions),
          timeLeft: quizData.timeLeft,
          currentQuestion: quizData.currentQuestionIndex,
          startTime: quizData.startTime,
          questionTimers: quizData.questionTimers, // Save per-question timers
          savedAt: Date.now()
        }));
        console.log('Progress saved to localStorage');
      } catch (error) {
        console.error('Error saving progress:', error);
      }
    }

    // Submit modal
    function showSubmitModal() {
      const answered = Object.keys(quizData.answers).length;
      const unanswered = quizData.questions.length - answered;
      
      document.getElementById('modalTotalQuestions').textContent = quizData.questions.length;
      document.getElementById('modalAnswered').textContent = answered;
      document.getElementById('modalUnanswered').textContent = unanswered;
      document.getElementById('modalTimeLeft').textContent = document.getElementById('timer').textContent;
      
      document.getElementById('submitModal').classList.remove('hidden');
    }

    function closeSubmitModal() {
      document.getElementById('submitModal').classList.add('hidden');
    }

    document.getElementById('submitBtn').addEventListener('click', showSubmitModal);
    document.getElementById('confirmSubmitBtn').addEventListener('click', () => {
      closeSubmitModal();
      submitQuiz(false);
    });

    // Submit quiz
    async function submitQuiz(isAutoSubmit = false) {
      try {
        console.log('=== SUBMITTING QUIZ ===');
        console.log('Exam ID:', examId);
        console.log('Answers:', quizData.answers);
        console.log('Number of answers:', Object.keys(quizData.answers).length);
        
        document.getElementById('loadingOverlay').classList.remove('hidden');
        
        // Calculate time spent in seconds
        const timeSpent = Math.floor((Date.now() - quizData.startTime) / 1000);
        console.log('Time spent:', timeSpent, 'seconds');
        
        const response = await API.post('/quiz/submit', {
          examId: examId,
          answers: quizData.answers,
          timeSpent: timeSpent
        });
        
        console.log('Submit response:', response);
        
        // Clear intervals
        if (timerInterval) clearInterval(timerInterval);
        if (autoSaveInterval) clearInterval(autoSaveInterval);
        if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);
        
        // Stop background music
        if (backgroundMusic && isMusicPlaying) {
          backgroundMusic.pause();
        }
        
        // Remove beforeunload listener
        window.removeEventListener('beforeunload', handleBeforeUnload);
        
        // Clear saved progress
        localStorage.removeItem(`quiz_${examId}`);
        
        const data = response.data || response;
        const resultId = data.result?._id || data.result?.id;
        
        // Redirect to results
        window.location.href = `/tracnghiemluyenthi/public/pages/results.html?result=${resultId}`;
        
      } catch (error) {
        console.error('=== ERROR SUBMITTING QUIZ ===');
        console.error('Error object:', error);
        console.error('Error message:', error.message);
        console.error('Error stack:', error.stack);
        
        document.getElementById('loadingOverlay').classList.add('hidden');
        
        // Show detailed error message
        const errorMessage = error.message || 'Kh√¥ng th·ªÉ n·ªôp b√†i. Vui l√≤ng th·ª≠ l·∫°i.';
        Utils.showToast(errorMessage, 'error');
        
        // If it's an auth error, redirect to login
        if (error.message && error.message.includes('token')) {
          setTimeout(() => {
            window.location.href = '/tracnghiemluyenthi/public/pages/auth/login.html';
          }, 2000);
        }
      }
    }

    // Fullscreen
    document.getElementById('fullscreenBtn').addEventListener('click', () => {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
        document.getElementById('fullscreenBtn').innerHTML = '<i class="fas fa-compress"></i>';
      } else {
        document.exitFullscreen();
        document.getElementById('fullscreenBtn').innerHTML = '<i class="fas fa-expand"></i>';
      }
    });

    // Prevent page unload
    function handleBeforeUnload(e) {
      e.preventDefault();
      e.returnValue = 'B·∫°n c√≥ ch·∫Øc mu·ªën tho√°t? B√†i l√†m c·ªßa b·∫°n s·∫Ω ƒë∆∞·ª£c l∆∞u t·ª± ƒë·ªông.';
      return e.returnValue;
    }

    // Toggle instructions
    function toggleInstructions() {
      const content = document.getElementById('instructionsContent');
      const icon = document.getElementById('instructionsIcon');
      
      content.classList.toggle('hidden');
      icon.classList.toggle('fa-chevron-down');
      icon.classList.toggle('fa-chevron-up');
    }

    // Initialize audio on first user interaction
    function initAudio() {
      console.log('üîä Initializing audio elements...');
      const correctSound = document.getElementById('correctSound');
      const wrongSound = document.getElementById('wrongSound');
      const bgMusic = document.getElementById('backgroundMusic');
      
      console.log('Audio elements:', { correctSound, wrongSound, bgMusic });
      
      if (correctSound) {
        correctSound.load();
        console.log('‚úÖ Correct sound loaded:', correctSound.src);
      }
      if (wrongSound) {
        wrongSound.load();
        console.log('‚úÖ Wrong sound loaded:', wrongSound.src);
      }
      if (bgMusic) {
        bgMusic.load();
        console.log('‚úÖ Background music loaded:', bgMusic.src);
      }
    }
    
    // Call initAudio when page loads
    document.addEventListener('DOMContentLoaded', initAudio);
    
    // Also call immediately in case DOMContentLoaded already fired
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      initAudio();
    }

    // Demo data for testing
    // Initialize
    loadExam();
  </script>
</body>
</html>
