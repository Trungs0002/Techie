<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API Testing - Quiz App</title>
  <link rel="stylesheet" href="/assets/css/main.css">
  <style>
    body {
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
      font-family: system-ui, -apple-system, sans-serif;
    }
    
    .test-section {
      margin: 20px 0;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #f9f9f9;
    }
    
    .test-section h2 {
      margin-top: 0;
      color: #333;
    }
    
    .test-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 15px 0;
    }
    
    button {
      padding: 10px 20px;
      background: #4F46E5;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }
    
    button:hover {
      background: #4338CA;
    }
    
    button:disabled {
      background: #9CA3AF;
      cursor: not-allowed;
    }
    
    .output {
      margin-top: 15px;
      padding: 15px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    
    .output.error {
      background: #FEE;
      border-color: #FCC;
      color: #C00;
    }
    
    .output.success {
      background: #EFE;
      border-color: #CFC;
      color: #060;
    }
    
    .status-info {
      padding: 10px;
      background: #E0E7FF;
      border-radius: 6px;
      margin-bottom: 20px;
    }
    
    .status-info strong {
      color: #4F46E5;
    }
    
    input, select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      margin: 5px 0;
    }
    
    .input-group {
      margin: 10px 0;
    }
    
    .input-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #333;
    }
  </style>
</head>
<body>
  <h1>ðŸ§ª API Testing Dashboard</h1>
  
  <div class="status-info">
    <strong>Backend:</strong> <span id="backendStatus">Checking...</span> |
    <strong>Token:</strong> <span id="tokenStatus">Not logged in</span>
  </div>

  <!-- 1. Health Check -->
  <div class="test-section">
    <h2>1. Health Check</h2>
    <div class="test-buttons">
      <button onclick="testHealth()">Check Server Health</button>
    </div>
    <div id="output-health" class="output"></div>
  </div>

  <!-- 2. Authentication -->
  <div class="test-section">
    <h2>2. Authentication</h2>
    
    <div class="input-group">
      <label>Username:</label>
      <input type="text" id="register-username" placeholder="testuser" value="testuser123">
    </div>
    <div class="input-group">
      <label>Email:</label>
      <input type="email" id="register-email" placeholder="test@example.com" value="testuser@example.com">
    </div>
    <div class="input-group">
      <label>Password:</label>
      <input type="password" id="register-password" placeholder="password" value="Password123!">
    </div>
    <div class="input-group">
      <label>Full Name (optional):</label>
      <input type="text" id="register-name" placeholder="John Doe" value="Test User">
    </div>
    
    <div class="test-buttons">
      <button onclick="testRegister()">Register New User</button>
      <button onclick="testLogin()">Login</button>
      <button onclick="testGetProfile()">Get Profile (Protected)</button>
    </div>
    <div id="output-auth" class="output"></div>
  </div>

  <!-- 3. Subjects -->
  <div class="test-section">
    <h2>3. Subjects</h2>
    <div class="test-buttons">
      <button onclick="testGetSubjects()">Get All Subjects</button>
      <button onclick="testGetSubjectDetails()">Get Subject Details</button>
    </div>
    <div id="output-subjects" class="output"></div>
  </div>

  <!-- 4. Exams -->
  <div class="test-section">
    <h2>4. Exams</h2>
    <div class="input-group">
      <label>Subject ID:</label>
      <input type="text" id="exam-subject-id" placeholder="Subject ID">
    </div>
    <div class="input-group">
      <label>Question Count:</label>
      <input type="number" id="exam-question-count" placeholder="10" value="10" min="1" max="50">
    </div>
    <div class="test-buttons">
      <button onclick="testStartNewExam()">Start New Exam</button>
      <button onclick="testGetExams()">Get My Exams by Subject</button>
      <button onclick="testGetExamDetails()">Get Exam Details</button>
    </div>
    <div id="output-exams" class="output"></div>
  </div>

  <!-- 5. Quiz -->
  <div class="test-section">
    <h2>5. Quiz</h2>
    <div class="input-group">
      <label>Exam ID:</label>
      <input type="text" id="quiz-exam-id" placeholder="Exam ID">
    </div>
    <div class="test-buttons">
      <button onclick="testStartQuiz()">Start Quiz</button>
      <button onclick="testSubmitQuiz()">Submit Quiz</button>
    </div>
    <div id="output-quiz" class="output"></div>
  </div>

  <!-- 6. Results & History -->
  <div class="test-section">
    <h2>6. Results & History</h2>
    <div class="test-buttons">
      <button onclick="testGetResults()">Get Latest Result</button>
      <button onclick="testGetHistory()">Get Exam History</button>
    </div>
    <div id="output-results" class="output"></div>
  </div>

  <script>
    const API_BASE_URL = 'http://localhost:5000/api';
    let authToken = null;
    let currentSubjectId = null;
    let currentExamId = null;
    let currentQuizId = null;

    // Update status
    function updateStatus() {
      authToken = localStorage.getItem('auth_token');
      const tokenStatus = document.getElementById('tokenStatus');
      
      if (authToken) {
        tokenStatus.textContent = 'Logged in âœ“';
        tokenStatus.style.color = '#060';
      } else {
        tokenStatus.textContent = 'Not logged in';
        tokenStatus.style.color = '#999';
      }
    }

    // Display output
    function displayOutput(elementId, data, isError = false) {
      const output = document.getElementById(elementId);
      output.className = 'output ' + (isError ? 'error' : 'success');
      output.textContent = JSON.stringify(data, null, 2);
    }

    // API call helper
    async function apiCall(url, options = {}) {
      try {
        const headers = {
          'Content-Type': 'application/json',
          ...options.headers
        };

        if (authToken && !options.skipAuth) {
          headers['Authorization'] = `Bearer ${authToken}`;
        }

        const response = await fetch(url, {
          ...options,
          headers
        });

        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.message || 'Request failed');
        }

        return data;
      } catch (error) {
        throw error;
      }
    }

    // 1. Health Check
    async function testHealth() {
      try {
        const data = await apiCall(`${API_BASE_URL}/../health`);
        displayOutput('output-health', data);
        document.getElementById('backendStatus').textContent = 'Connected âœ“';
        document.getElementById('backendStatus').style.color = '#060';
      } catch (error) {
        displayOutput('output-health', { error: error.message }, true);
        document.getElementById('backendStatus').textContent = 'Disconnected âœ—';
        document.getElementById('backendStatus').style.color = '#C00';
      }
    }

    // 2. Authentication - Register
    async function testRegister() {
      try {
        const username = document.getElementById('register-username').value;
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        const fullName = document.getElementById('register-name').value;

        const data = await apiCall(`${API_BASE_URL}/auth/register`, {
          method: 'POST',
          body: JSON.stringify({ username, email, password, fullName })
        });

        displayOutput('output-auth', data);
        
        if (data.data && data.data.token) {
          authToken = data.data.token;
          localStorage.setItem('auth_token', data.data.token);
          localStorage.setItem('user_data', JSON.stringify(data.data.user));
          updateStatus();
        }
      } catch (error) {
        displayOutput('output-auth', { error: error.message }, true);
      }
    }

    // 2. Authentication - Login
    async function testLogin() {
      try {
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;

        const data = await apiCall(`${API_BASE_URL}/auth/login`, {
          method: 'POST',
          body: JSON.stringify({ email, password })
        });

        displayOutput('output-auth', data);
        
        if (data.data && data.data.token) {
          authToken = data.data.token;
          localStorage.setItem('auth_token', data.data.token);
          localStorage.setItem('user_data', JSON.stringify(data.data.user));
          updateStatus();
        }
      } catch (error) {
        displayOutput('output-auth', { error: error.message }, true);
      }
    }

    // 2. Authentication - Get Profile
    async function testGetProfile() {
      try {
        const data = await apiCall(`${API_BASE_URL}/auth/me`);
        displayOutput('output-auth', data);
      } catch (error) {
        displayOutput('output-auth', { error: error.message }, true);
      }
    }

    // 3. Subjects - Get All
    async function testGetSubjects() {
      try {
        const response = await apiCall(`${API_BASE_URL}/subjects`);
        displayOutput('output-subjects', response);
        
        // Handle response structure: {success: true, data: {subjects}}
        const subjects = response.data?.subjects || response.subjects || [];
        if (subjects.length > 0) {
          currentSubjectId = subjects[0]._id;
          document.getElementById('exam-subject-id').value = currentSubjectId;
        }
      } catch (error) {
        displayOutput('output-subjects', { error: error.message }, true);
      }
    }

    // 3. Subjects - Get Details
    async function testGetSubjectDetails() {
      try {
        if (!currentSubjectId) {
          throw new Error('Run "Get All Subjects" first to get a subject ID');
        }
        
        const data = await apiCall(`${API_BASE_URL}/subjects/${currentSubjectId}`);
        displayOutput('output-subjects', data);
      } catch (error) {
        displayOutput('output-subjects', { error: error.message }, true);
      }
    }

    // 4. Exams - Start New Exam
    async function testStartNewExam() {
      try {
        const subjectId = document.getElementById('exam-subject-id').value || currentSubjectId;
        const questionCount = parseInt(document.getElementById('exam-question-count').value) || 10;
        
        if (!subjectId) {
          throw new Error('Please enter a Subject ID or run "Get All Subjects" first');
        }
        
        const response = await apiCall(`${API_BASE_URL}/exams/start`, {
          method: 'POST',
          body: JSON.stringify({ 
            subjectId, 
            questionCount,
            timeLimit: 30, // 30 minutes
            type: 'practice'
          })
        });
        
        displayOutput('output-exams', response);
        
        // Handle response structure
        const exam = response.data?.exam || response.exam;
        if (exam) {
          currentExamId = exam._id;
          document.getElementById('quiz-exam-id').value = currentExamId;
        }
      } catch (error) {
        displayOutput('output-exams', { error: error.message }, true);
      }
    }

    // 4. Exams - Get by Subject
    async function testGetExams() {
      try {
        const subjectId = document.getElementById('exam-subject-id').value || currentSubjectId;
        
        if (!subjectId) {
          throw new Error('Please enter a Subject ID or run "Get All Subjects" first');
        }
        
        // Try to get existing exams first
        const response = await apiCall(`${API_BASE_URL}/exams?subjectId=${subjectId}`);
        displayOutput('output-exams', response);
        
        // Handle response structure: {success: true, data: {exams}}
        const exams = response.data?.exams || response.exams || [];
        if (exams.length > 0) {
          currentExamId = exams[0]._id;
          document.getElementById('quiz-exam-id').value = currentExamId;
        } else {
          // No exams yet, suggest creating one
          displayOutput('output-exams', {
            ...response,
            note: 'No exams found. Use "Start New Exam" to create one.'
          });
        }
      } catch (error) {
        displayOutput('output-exams', { error: error.message }, true);
      }
    }

    // 4. Exams - Get Details
    async function testGetExamDetails() {
      try {
        if (!currentExamId) {
          throw new Error('Run "Get Exams by Subject" first to get an exam ID');
        }
        
        const data = await apiCall(`${API_BASE_URL}/exams/${currentExamId}`);
        displayOutput('output-exams', data);
      } catch (error) {
        displayOutput('output-exams', { error: error.message }, true);
      }
    }

    // 5. Quiz - Start
    async function testStartQuiz() {
      try {
        const examId = document.getElementById('quiz-exam-id').value || currentExamId;
        
        if (!examId) {
          throw new Error('Please enter an Exam ID or run "Get Exams by Subject" first');
        }
        
        const data = await apiCall(`${API_BASE_URL}/quiz/start`, {
          method: 'POST',
          body: JSON.stringify({ examId })
        });
        
        displayOutput('output-quiz', data);
        
        if (data.quizSession) {
          currentQuizId = data.quizSession._id;
        }
      } catch (error) {
        displayOutput('output-quiz', { error: error.message }, true);
      }
    }

    // 5. Quiz - Submit
    async function testSubmitQuiz() {
      try {
        const examId = document.getElementById('quiz-exam-id').value || currentExamId;
        
        if (!examId) {
          throw new Error('Please start a quiz first or enter an Exam ID');
        }
        
        // Create dummy answers (empty for testing)
        const answers = {};
        const timeSpent = 60; // 1 minute for testing
        
        const data = await apiCall(`${API_BASE_URL}/quiz/submit`, {
          method: 'POST',
          body: JSON.stringify({ examId, answers, timeSpent })
        });
        
        displayOutput('output-quiz', data);
      } catch (error) {
        displayOutput('output-quiz', { error: error.message }, true);
      }
    }

    // 6. Results - Get Latest
    async function testGetResults() {
      try {
        const data = await apiCall(`${API_BASE_URL}/quiz/history?limit=1`);
        displayOutput('output-results', data);
      } catch (error) {
        displayOutput('output-results', { error: error.message }, true);
      }
    }

    // 6. History - Get All
    async function testGetHistory() {
      try {
        const data = await apiCall(`${API_BASE_URL}/quiz/history`);
        displayOutput('output-results', data);
      } catch (error) {
        displayOutput('output-results', { error: error.message }, true);
      }
    }

    // Initialize
    window.addEventListener('DOMContentLoaded', () => {
      updateStatus();
      testHealth();
    });
  </script>
</body>
</html>
